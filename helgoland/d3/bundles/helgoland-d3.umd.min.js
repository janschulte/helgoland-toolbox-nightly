!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@helgoland/core"),require("@ngx-translate/core"),require("d3"),require("moment")):"function"==typeof define&&define.amd?define("@helgoland/d3",["exports","@angular/core","@helgoland/core","@ngx-translate/core","d3","moment"],e):e((t.helgoland=t.helgoland||{},t.helgoland.d3={}),t.ng.core,null,null,null,null)}(this,function(t,d,n,e,k,v){"use strict";v=v&&v.hasOwnProperty("default")?v["default"]:v;var a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};function i(t,e){function i(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var s=function(){function t(t,e){this.timeSrvc=t,this.cd=e,this.onTimespanChanged=new d.EventEmitter,this.onLoading=new d.EventEmitter,this.onContentLoading=new d.EventEmitter,this.init=!1,this.presenterOptions?this.presenterOptions.overview=!0:this.presenterOptions={overview:!0}}return t.prototype.ngAfterViewInit=function(){this.rangefactor=this.rangefactor||1,this.calculateOverviewRange(),this.init=!0,this.cd.detectChanges()},t.prototype.ngOnChanges=function(t){t.timeInterval&&this.init&&this.calculateOverviewRange()},t.prototype.ngOnDestroy=function(){this.cd.detach()},t.prototype.timeSpanChanged=function(t){this.onTimespanChanged.emit(t)},t.prototype.onGraphLoading=function(t){this.isContentLoading(t)},t.prototype.calculateOverviewRange=function(){var t=this.timeSrvc.createTimespanOfInterval(this.timeInterval);this.timespan=t,this.overviewTimespan=this.timeSrvc.getBufferedTimespan(t,this.rangefactor)},t.decorators=[{type:d.Component,args:[{selector:"n52-d3-overview-timeseries-graph",template:'<n52-d3-timeseries-graph [datasetIds]="datasetIds" [datasetOptions]="datasetOptions" [reloadForDatasets]="reloadForDatasets"\n    [timeInterval]="overviewTimespan" [mainTimeInterval]="timespan" [presenterOptions]="presenterOptions" (onTimespanChanged)="timeSpanChanged($event)"\n    (onContentLoading)="onGraphLoading($event)"></n52-d3-timeseries-graph>',styles:[":host .d3{height:100%}"]}]}],t.ctorParameters=function(){return[{type:n.Time},{type:d.ChangeDetectorRef}]},t.propDecorators={datasetIds:[{type:d.Input}],datasetOptions:[{type:d.Input}],presenterOptions:[{type:d.Input}],timeInterval:[{type:d.Input}],rangefactor:[{type:d.Input}],reloadForDatasets:[{type:d.Input}],onTimespanChanged:[{type:d.Output}],onLoading:[{type:d.Output}],onContentLoading:[{type:d.Output}]},t=function(t,e,i,a){var s,n=arguments.length,r=n<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,a);else for(var o=t.length-1;0<=o;o--)(s=t[o])&&(r=(n<3?s(r):3<n?s(e,i,r):s(e,i))||r);return 3<n&&r&&Object.defineProperty(e,i,r),r}([n.Mixin([n.HasLoadableContent]),function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}("design:paramtypes",[n.Time,d.ChangeDetectorRef])],t)}(),r=function(){function t(t){this.translateService=t,this.timeFormatLocaleMapper=new Map}return t.prototype.addTimeFormatLocale=function(t,e){this.timeFormatLocaleMapper.set(t,e)},t.prototype.getTimeLocale=function(t){var e=this.translateService.currentLang;return this.timeFormatLocaleMapper.has(e)?k.timeFormatLocale(this.timeFormatLocaleMapper.get(e)).format(t):k.timeFormat(t)},t.decorators=[{type:d.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:e.TranslateService}]},t.ngInjectableDef=d.defineInjectable({factory:function(){return new t(d.inject(e.TranslateService))},token:t,providedIn:"root"}),t}(),h={none:"none",line:"line",point:"point"},o=function(o){function t(t,e,i,a,s,n,r){var l=o.call(this,t,e,i,a,r)||this;return l.iterableDiffers=t,l.api=e,l.datasetIdResolver=i,l.timeSrvc=a,l.timeFormatLocaleService=s,l.colorService=n,l.translateService=r,l.onHighlightChanged=new d.EventEmitter,l.onClickDataPoint=new d.EventEmitter,l.preparedData=[],l.datasetMap=new Map,l.listOfUoms=[],l.yRangesEachUom=[],l.dataYranges=[],l.xAxisRangeOrigin=[],l.listOfSeparation=Array(),l.margin={top:10,right:10,bottom:40,left:40},l.maxLabelwidth=0,l.opac={"default":0,hover:.3,click:.5},l.addLineWidth=2,l.loadingCounter=0,l.plotOptions={showReferenceValues:!1,generalizeAllways:!0,togglePanZoom:!0,hoverable:!0,hoverStyle:h.point,grid:!0,yaxis:!0,overview:!1,showTimeLabel:!0,requestBeforeAfterValues:!1},l.mousemoveHandler=function(){var a=k.mouse(l.background.node());l.labelTimestamp=[],l.labelXCoord=[],l.distLabelXCoord=[],l.preparedData.forEach(function(t,e){var i=l.getItemForX(a[0]+l.bufferSum,t.data);l.showDiagramIndicator(t,i,a[0],e)});var t=[];for(var e in l.highlightOutput.ids)l.highlightOutput.ids.hasOwnProperty(e)&&t.push(e);if(t.length<=0)l.focusG.style("visibility","hidden");else{for(var r=0,o=!1,h=!0,i=[],s=k.selectAll(".focus-visibility").nodes(),n=0;n<s.length;n+=2)i.push([s[n],s[n+1]]);i.sort(function(t,e){return parseFloat(k.select(t[0]).attr("y"))-parseFloat(k.select(e[0]).attr("y"))}),i.forEach(function(n){k.select(n[0]).attr("transform",function(t,e,i){if("hidden"!==k.select(n[0]).attr("visibility")){o=!0;var a=parseFloat(k.select(n[0]).attr("y")),s=0;if(h||(s=Math.max(0,r+30-a))<10&&(s=10),0<s)return"translate(0, "+s+")"}return"translate(0, 0)"}),k.select(n[1]).attr("transform",function(t,e,i){if("hidden"!==k.select(n[1]).attr("visibility")){o=!0;var a=parseFloat(k.select(n[0]).attr("y")),s=0;if(h||(s=Math.max(0,r+30-a))<10&&(s=10),r=s+a,0<s)return"translate(0, "+s+")"}return"translate(0, 0)"}),o&&(h=!1)})}l.onHighlightChanged.emit(l.highlightOutput)},l.mouseoutHandler=function(){l.hideDiagramIndicator()},l.panStartHandler=function(){l.draggingMove=!1,l.dragMoveStart=k.event.x,l.dragMoveRange=[l.xAxisRange.from,l.xAxisRange.to]},l.panMoveHandler=function(){if(l.draggingMove=!0,l.dragMoveStart&&l.draggingMove){var t=-(k.event.x-l.dragMoveStart),e=(l.dragMoveRange[1]-l.dragMoveRange[0])/l.width,i=l.dragMoveRange[0]+e*t,a=l.dragMoveRange[1]+e*t;l.xAxisRangePan=[i,a],l.timespan={from:l.xAxisRangePan[0],to:l.xAxisRangePan[1]},l.plotGraph()}},l.panEndHandler=function(){l.xAxisRangePan&&(l.changeTime(l.xAxisRangePan[0],l.xAxisRangePan[1]),l.plotGraph(),l.dragMoveStart=null,l.draggingMove=!1,l.xAxisRangePan=null)},l.zoomStartHandler=function(){l.dragging=!1,l.dragStart=k.mouse(l.background.node()),l.xAxisRangeOrigin.push([l.xAxisRange.from,l.xAxisRange.to])},l.zoomHandler=function(){l.dragging=!0,l.drawDragRectangle()},l.zoomEndHandler=function(){if(l.dragStart&&l.dragging){var t=void 0;t=l.dragStart[0]<=l.dragCurrent[0]?l.getxDomain(l.dragStart[0],l.dragCurrent[0]):l.getxDomain(l.dragCurrent[0],l.dragStart[0]),l.xAxisRange={from:t[0],to:t[1]},l.changeTime(l.xAxisRange.from,l.xAxisRange.to),l.plotGraph()}else l.xAxisRangeOrigin[0]&&(l.changeTime(l.xAxisRangeOrigin[0][0],l.xAxisRangeOrigin[0][1]),l.xAxisRangeOrigin=[],l.plotGraph());l.dragStart=null,l.dragging=!1,l.resetDrag()},l.showDiagramIndicator=function(t,e,i,a){var s=t.data[e];if(l.labelXCoord[a]=null,l.distLabelXCoord[a]=null,s!==undefined&&s.yDiagCoord&&s[1]!==undefined){l.focusG.style("visibility","visible"),l.chVisLabel(t,!0,a);var n=i+l.bufferSum,r=l.timespan.from/(l.timespan.to-l.timespan.from)*1e-4*(l.timespan.from/(l.timespan.to-l.timespan.from)*1e-4);r=Math.max(10,r),l.showLabelValues(t,s),l.showTimeIndicatorLabel(s,a,n),(s.xDiagCoord>=l.background.node().getBBox().width+l.bufferSum||n<s.xDiagCoord-r)&&l.chVisLabel(t,!1,a),n<s.xDiagCoord&&t.data[e-1]&&Math.abs(t.data[e-1].xDiagCoord-n)<Math.abs(s.xDiagCoord-n)&&(l.chVisLabel(t,!1,a),l.showLabelValues(t,t.data[e-1]),l.showTimeIndicatorLabel(t.data[e-1],a,n),l.chVisLabel(t,!0,a),(t.data[e-1].xDiagCoord>=l.background.node().getBBox().width+l.bufferSum||t.data[e-1].xDiagCoord<=l.bufferSum||t.data[e-1].xDiagCoord+r<n)&&l.chVisLabel(t,!1,a))}else l.chVisLabel(t,!1,a)},l}return i(t,o),t.prototype.ngAfterViewInit=function(){this.currentTimeId=this.uuidv4(),this.rawSvg=k.select(this.d3Elem.nativeElement).append("svg").attr("width","100%").attr("height","100%"),this.graph=this.rawSvg.append("g").attr("transform","translate("+(this.margin.left+this.maxLabelwidth)+","+this.margin.top+")"),this.graphFocus=this.rawSvg.append("g").attr("transform","translate("+(this.margin.left+this.maxLabelwidth)+","+this.margin.top+")"),this.mousedownBrush=!1,this.plotGraph()},t.prototype.onLanguageChanged=function(t){this.plotGraph()},t.prototype.reloadDataForDatasets=function(t){var e=this;t.forEach(function(t){e.datasetMap.has(t)&&e.loadDatasetData(e.datasetMap.get(t),!0)})},t.prototype.addDataset=function(e,i){var a=this;this.api.getSingleTimeseries(e,i).subscribe(function(t){return a.loadAddedDataset(t)},function(t){a.api.getDataset(e,i).subscribe(function(t){return a.loadAddedDataset(t)})})},t.prototype.removeDataset=function(e){var i=this;this.dataYranges=[],this.xAxisRangeOrigin=[],this.datasetMap["delete"](e);var t=this.preparedData.findIndex(function(t){return t.internalId===e});0<=t&&(this.preparedData.splice(t,1),this.preparedData.length<=0?(this.yRangesEachUom=[],this.plotGraph()):this.preparedData.forEach(function(t){i.processData(t)}))},t.prototype.setSelectedId=function(e){var t=this.preparedData.find(function(t){return t.internalId===e});if(!t.selected||t.selected===undefined)if(t.selected=!0,t.lines.lineWidth+=this.addLineWidth,0<t.lines.pointRadius?t.lines.pointRadius+=this.addLineWidth:t.lines.pointRadius+=0,t.bars.lineWidth+=this.addLineWidth,t.axisOptions.separateYAxis||!this.plotOptions.groupYaxis)this.checkYselector(t.internalId,t.axisOptions.uom),this.yAxisSelect[e]&&(this.yAxisSelect[e].clicked=!0);else{var i=t.axisOptions.uom,a=this.yRangesEachUom.find(function(t){return t.uom===i});0<=a.ids.findIndex(function(t){return t===e})&&(this.checkYselector(i,t.axisOptions.uom),this.yAxisSelect[i].clicked=!0,this.yAxisSelect[i].ids.push(e),a!==undefined&&a.ids!==undefined&&(this.yAxisSelect[i].ids.length!==a.ids.length?this.yAxisSelect[i].clicked=!1:this.yAxisSelect[i].clicked=!0))}this.plotGraph()},t.prototype.removeSelectedId=function(e){var t=this.preparedData.find(function(t){return t.internalId===e});if(t.selected||t.selected===undefined)if(t.selected=!1,t.lines.lineWidth-=this.addLineWidth,0<t.lines.pointRadius?t.lines.pointRadius-=this.addLineWidth:t.lines.pointRadius-=0,t.bars.lineWidth-=this.addLineWidth,t.axisOptions.separateYAxis||!this.plotOptions.groupYaxis)this.checkYselector(t.internalId,t.axisOptions.uom),this.yAxisSelect[t.internalId]&&(this.yAxisSelect[t.internalId].clicked=!1,this.yAxisSelect[t.internalId]&&(this.yAxisSelect[t.internalId].ids=[]));else{var i=t.axisOptions.uom;this.checkYselector(i,t.axisOptions.uom),this.yAxisSelect[i].ids=this.yAxisSelect[i].ids.filter(function(t){return t!==e}),this.yAxisSelect[i].clicked=!1}this.plotGraph()},t.prototype.presenterOptionsChanged=function(t){this.oldGroupYaxis=this.plotOptions.groupYaxis,this.plotOptions.hoverStyle!==h.point&&t.hoverStyle===h.point&&k.select("g.d3line").attr("visibility","visible"),Object.assign(this.plotOptions,t),this.rawSvg&&this.yRangesEachUom&&this.plotGraph()},t.prototype.datasetOptionsChanged=function(t,e,i){!i&&this.datasetMap.has(t)&&this.loadDatasetData(this.datasetMap.get(t),!1)},t.prototype.timeIntervalChanges=function(){var e=this;this.datasetMap.forEach(function(t){e.loadDatasetData(t,!1)})},t.prototype.onResize=function(){this.plotGraph()},t.prototype.centerTime=function(t){var e=this.timeSrvc.centerTimespan(this.timespan,new Date(t));this.onTimespanChanged.emit(e)},t.prototype.changeTime=function(t,e){this.onTimespanChanged.emit(new n.Timespan(t,e))},t.prototype.loadAddedDataset=function(t){this.datasetMap.set(t.internalId,t),this.loadDatasetData(t,!1)},t.prototype.loadDatasetData=function(e,t){var i=this,a=this.datasetOptions.get(e.internalId);if(0===this.loadingCounter&&this.onContentLoading.emit(!0),this.loadingCounter++,e instanceof n.Timeseries){var s=this.timeSrvc.getBufferedTimespan(this.timespan,.2);this.api.getTsData(e.id,e.url,s,{format:"flot",expanded:this.plotOptions.showReferenceValues||this.plotOptions.requestBeforeAfterValues,generalize:this.plotOptions.generalizeAllways||a.generalize},{forceUpdate:t}).subscribe(function(t){return i.prepareTsData(e,t)},function(t){return i.onError(t)},function(){return i.onCompleteLoadingData()})}},t.prototype.onCompleteLoadingData=function(){this.loadingCounter--,0===this.loadingCounter&&this.onContentLoading.emit(!1)},t.prototype.prepareTsData=function(e,t){t.valueBeforeTimespan&&t.values.unshift(t.valueBeforeTimespan),t.valueAfterTimespan&&t.values.push(t.valueAfterTimespan),this.datasetMap.get(e.internalId).data=t;var i=this.preparedData.findIndex(function(t){return t.internalId===e.internalId}),a=this.datasetOptions.get(e.internalId);a.color===undefined&&(a.color=this.colorService.getColor());var s={internalId:e.internalId,id:0<=i?i:this.preparedData.length,color:a.color,data:a.visible?t.values.map(function(t){return{timestamp:t[0],value:t[1]}}):[],points:{fillColor:a.color},lines:{lineWidth:a.lineWidth,pointRadius:a.pointRadius},bars:{lineWidth:a.lineWidth},axisOptions:{uom:e.uom,label:e.label,zeroBased:a.zeroBasedYAxis,yAxisRange:a.yAxisRange,autoRangeSelection:a.autoRangeSelection,separateYAxis:a.separateYAxis,parameters:{feature:e.parameters.feature,phenomenon:e.parameters.phenomenon,offering:e.parameters.offering}},visible:a.visible},n=this.listOfSeparation.findIndex(function(t){return t===e.internalId});if(a.separateYAxis?n<0&&this.listOfSeparation.push(e.internalId):this.listOfSeparation=this.listOfSeparation.filter(function(t){return t!==e.internalId}),0<=this.selectedDatasetIds.indexOf(e.internalId)&&(s.lines.lineWidth+=this.addLineWidth,0<s.lines.pointRadius?s.lines.pointRadius+=this.addLineWidth:s.lines.pointRadius+=0,s.bars.lineWidth+=this.addLineWidth,a.separateYAxis&&(this.checkYselector(s.internalId,s.axisOptions.uom),this.yAxisSelect[s.internalId]&&(this.yAxisSelect[s.internalId].clicked=!0,this.yAxisSelect[s.internalId].ids.push(s.internalId)))),this.yAxisSelect)if(a.separateYAxis){if(this.yAxisSelect[s.axisOptions.uom]){var r=this.yAxisSelect[s.axisOptions.uom].ids.findIndex(function(t){return t===s.internalId});0<=r&&this.yAxisSelect[s.axisOptions.uom].ids.splice(r,1);var o=this.countGroupedDatasets(s.axisOptions.uom,s.internalId);this.yAxisSelect[s.axisOptions.uom].ids.length===o&&(this.yAxisSelect[s.axisOptions.uom].clicked=!0)}}else this.yAxisSelect[s.internalId]&&this.yAxisSelect[s.axisOptions.uom]&&(this.yAxisSelect[s.internalId].clicked?this.yAxisSelect[s.axisOptions.uom].ids.push(s.internalId):this.yAxisSelect[s.axisOptions.uom].clicked=!1,delete this.yAxisSelect[s.internalId]);0<=i?this.preparedData[i]=s:this.preparedData.push(s),this.addReferenceValueData(e.internalId,a,t,e.uom),this.processData(s)},t.prototype.addReferenceValueData=function(i,t,a,s){var n=this;this.preparedData=this.preparedData.filter(function(t){return!t.internalId.startsWith("ref"+i)}),this.plotOptions.showReferenceValues&&t.showReferenceValues.forEach(function(t){var e={internalId:"ref"+i+t.id,color:t.color,visible:!0,data:a.referenceValues[t.id].map(function(t){return{timestamp:t[0],value:t[1]}}),points:{fillColor:t.color},lines:{lineWidth:1},axisOptions:{uom:s}};n.preparedData.push(e)})},t.prototype.processData=function(e){var t,i,a,s,n=this;e.axisOptions.yAxisRange&&e.axisOptions.yAxisRange.min!==e.axisOptions.yAxisRange.max&&(s=e.axisOptions.yAxisRange);var r=e.axisOptions.autoRangeSelection,o=k.extent(e.data,function(t){return t.value}),h=!(a={min:o[0],max:o[1]});s&&!this.plotOptions.overview?(s.min>s.max?(t={min:s.max,max:s.min},i={min:s.max,max:s.min}):(t={min:s.min,max:s.max},i={min:s.min,max:s.max}),(s.min>o[1]||s.max<o[0])&&(h=!r)):h=!0,h&&(t={min:o[0],max:o[1]},this.extendRange(t)),e.axisOptions.zeroBased&&!this.plotOptions.overview&&(o[1]<=0&&(t.max=0,i&&(i.max=0)),0<=o[0]&&(t.min=0,i&&(i.min=0)));var l=this.preparedData.findIndex(function(t){return t.internalId===e.internalId});e.visible?(this.dataYranges[l]={uom:e.axisOptions.uom,id:e.internalId,zeroBased:e.axisOptions.zeroBased,outOfrange:h,autoRange:r,parameters:e.axisOptions.parameters},isFinite(t.min)&&isFinite(t.max)&&(this.dataYranges[l].range=t,this.dataYranges[l].preRange=i,this.dataYranges[l].originRange=a)):this.dataYranges[l]=null,this.yRangesEachUom=[],this.dataYranges.forEach(function(e){if(null!==e){var t=n.yRangesEachUom.findIndex(function(t){return t.uom===e.uom}),i={uom:e.uom,range:e.range,preRange:e.preRange,originRange:e.originRange,ids:[e.id],zeroBased:e.zeroBased,outOfrange:e.outOfrange,autoRange:e.autoRange,parameters:e.parameters};0<=t?(n.yRangesEachUom[t].range?e.range&&(n.yRangesEachUom[t].autoRange||e.autoRange?(e.preRange&&n.yRangesEachUom[t].preRange?(n.checkCurrentLatest(t,e,"preRange"),n.yRangesEachUom[t].range=n.yRangesEachUom[t].preRange):n.checkCurrentLatest(t,e,"range"),n.yRangesEachUom[t].autoRange=!0):e.outOfrange!==n.yRangesEachUom[t].outOfrange?(n.checkCurrentLatest(t,e,"originRange"),n.yRangesEachUom[t].range=n.yRangesEachUom[t].originRange):n.checkCurrentLatest(t,e,"range")):n.takeLatest(t,e,"range"),n.yRangesEachUom[t].ids.push(e.id)):n.yRangesEachUom.push(i)}}),this.graph&&this.plotGraph()},t.prototype.extendRange=function(t){t.min===t.max&&(t.min=t.min-1,t.max=t.max+1)},t.prototype.checkCurrentLatest=function(t,e,i){this.yRangesEachUom[t][i].min>e[i].min&&!isNaN(e[i].min)&&(this.yRangesEachUom[t][i].min=e[i].min),this.yRangesEachUom[t][i].max<e[i].max&&!isNaN(e[i].max)&&(this.yRangesEachUom[t][i].max=e[i].max)},t.prototype.takeLatest=function(t,e,i){this.yRangesEachUom[t][i]=e[i]},t.prototype.calculateHeight=function(){return this.d3Elem.nativeElement.clientHeight-this.margin.top-this.margin.bottom+(this.plotOptions.showTimeLabel?0:20)},t.prototype.calculateWidth=function(){return this.rawSvg.node().width.baseVal.value-this.margin.left-this.margin.right-this.maxLabelwidth},t.prototype.getyAxisRange=function(e){var t=this.yRangesEachUom.find(function(t){return t.uom===e});return t?t.range:null},t.prototype.plotGraph=function(){var s=this;if(this.highlightOutput={timestamp:0,ids:new Map},this.yRangesEachUom){this.preparedData.forEach(function(e){s.listOfUoms.findIndex(function(t){return t===e.axisOptions.uom})<0&&s.listOfUoms.push(e.axisOptions.uom)}),this.oldGroupYaxis!==this.plotOptions.groupYaxis&&this.changeYselection(),this.height=this.calculateHeight(),this.width=this.calculateWidth(),this.graph.selectAll("*").remove(),this.graphFocus.selectAll("*").remove(),this.bufferSum=0,this.yScaleBase=null,this.xAxisRange=this.timespan;var n=[];if(this.plotOptions.groupYaxis||this.plotOptions.groupYaxis===undefined?(n=this.yRangesEachUom,0<this.listOfSeparation.length&&this.listOfSeparation.forEach(function(e){var i=s.dataYranges.find(function(t){return null!==t&&t.id===e});if(i&&n.findIndex(function(t){return t.id===i.id})<0){var t=n.findIndex(function(t){return t.uom===i.uom&&(t.ids!==undefined||0===t.ids.length)});if(0<=t){var a=n[t].ids.findIndex(function(t){return t===e});0<=a&&n[t].ids.splice(a,1),0===n[t].ids.length&&n.splice(t,1)}n.push(i)}})):n=this.dataYranges,n.forEach(function(t){if(null!==t){t.first=null===s.yScaleBase,t.offset=s.bufferSum;var e=s.drawYaxis(t);null===s.yScaleBase&&(s.yScaleBase=e.yScale),s.bufferSum=e.buffer,t.yScale=e.yScale}}),this.yScaleBase)if(this.drawXaxis(this.bufferSum),this.background=this.graph.append("svg:rect").attr("width",this.width-this.bufferSum).attr("height",this.height).attr("id","backgroundRect").attr("fill","none").attr("stroke","none").attr("pointer-events","all").attr("transform","translate("+this.bufferSum+", 0)"),this.drawAllGraphLines(),this.addTimespanJumpButtons(),this.plotOptions.overview){var t=this.getXDomainByTimestamp(),e=[t[0],t[1]],i=k.brushX().extent([[0,0],[this.width,this.height]]).on("end",function(){if(s.mousedownBrush){var t=s.getTimestampByCoord(k.event.selection[0],k.event.selection[1]);s.changeTime(t[0],t[1])}s.mousedownBrush=!1});this.background=this.graph.append("g").attr("width",this.width).attr("height",this.height).attr("pointer-events","all").attr("class","brush").call(i).call(i.move,e),this.background.selectAll(".selection").attr("stroke","none").on("mousedown",function(){s.mousedownBrush=!0}),this.background.selectAll(".overlay").remove(),this.background.selectAll(".handle").style("fill","red").style("opacity",.3).attr("stroke","none").on("mousedown",function(){s.mousedownBrush=!0})}else this.plotOptions.hoverable&&(this.plotOptions.hoverStyle===h.line?this.createLineHovering():k.select("g.d3line").attr("visibility","hidden")),!1===this.plotOptions.togglePanZoom?this.background.call(k.zoom().on("start",this.zoomStartHandler).on("zoom",this.zoomHandler).on("end",this.zoomEndHandler)):this.background.call(k.drag().on("start",this.panStartHandler).on("drag",this.panMoveHandler).on("end",this.panEndHandler)),this.createCopyrightLabel()}},t.prototype.createPointHovering=function(e,t){var i=this;this.graphBody.selectAll(".hoverDots").data(e.data.filter(function(t){return!isNaN(t.value)})).enter().append("circle").attr("class","hoverDots").attr("id",function(t){return"hover-dot-"+t.timestamp+"-"+e.id}).attr("stroke","transparent").attr("fill","transparent").attr("cx",t.x()).attr("cy",t.y()).attr("r",e.lines.pointRadius+3).on("mouseover",function(t){return i.mouseOverPointHovering(t,e)}).on("mouseout",function(t){return i.mouseOutPointHovering(t,e)}).on("mousedown",function(t){return i.clickDataPoint(t,e)})},t.prototype.createLineHovering=function(){var e=this;this.background.on("mousemove.focus",this.mousemoveHandler).on("mouseout.focus",this.mouseoutHandler),this.highlightFocus=this.focusG.append("svg:line").attr("class","mouse-focus-line").attr("x2","0").attr("y2","0").attr("x1","0").attr("y1","0").style("stroke","black").style("stroke-width","1px"),this.preparedData.forEach(function(t){t.focusLabelRect=e.focusG.append("svg:rect").attr("class","mouse-focus-label").style("fill","white").style("stroke","none").style("pointer-events","none"),t.focusLabel=e.focusG.append("svg:text").attr("class","mouse-focus-label").style("pointer-events","none").style("fill",t.color).style("font-weight","lighter"),e.focuslabelTime=e.focusG.append("svg:text").style("pointer-events","none").attr("class","mouse-focus-time")})},t.prototype.clickDataPoint=function(t,e){var i=this;if(console.log("click point"),t!==undefined){var a=this.datasetIdResolver.resolveInternalId(e.internalId).url,s={from:t.timestamp,to:t.timestamp};this.api.getTimeseries(a,{offering:e.axisOptions.parameters.offering.id,feature:e.axisOptions.parameters.feature.id}).subscribe(function(t){var e=[];t.forEach(function(t){e.push(t.id)}),i.api.getTimeseriesData(a,e,s).subscribe(function(t){return i.onClickDataPoint.emit(t)},function(t){return console.error(t)})},function(t){return console.error(t)})}},t.prototype.addTimespanJumpButtons=function(){var e=this,i=!1,a=null,s=null;if(this.plotOptions.requestBeforeAfterValues&&this.preparedData.forEach(function(t){t.data.findIndex(function(t){return e.timespan.from<t[0]&&e.timespan.to>t[0]&&isFinite(t[1])})<0?(0<=t.data.findIndex(function(t){return t[0]>e.timespan.from&&t[0]>e.timespan.to&&isFinite(t[1])})&&(s=t.data[t.data.length-1][0]),0<=t.data.findIndex(function(t){return t[0]<e.timespan.from&&t[0]<e.timespan.to&&isFinite(t[1])})&&(a=t.data[t.data.length-1][0])):i=!0}),!i){var t;if(a)(t=this.background.append("g")).append("svg:rect").attr("class","formerButton").attr("width","50px").attr("height",this.height+"px").attr("transform","translate("+this.bufferSum+", 0)").on("click",function(){return e.centerTime(a)}),t.append("line").attr("class","arrow").attr("x1",0+this.bufferSum+15+"px").attr("y1",this.height/2+"px").attr("x2",0+this.bufferSum+35+"px").attr("y2",this.height/2-17.5+"px"),t.append("line").attr("class","arrow").attr("x1",0+this.bufferSum+15+"px").attr("y1",this.height/2+"px").attr("x2",0+this.bufferSum+35+"px").attr("y2",this.height/2+17.5+"px");if(s)(t=this.background.append("g")).append("svg:rect").attr("class","laterButton").attr("width","50px").attr("height",this.height).attr("transform","translate("+(this.width-50)+", 0)").on("click",function(){return e.centerTime(s)}),t.append("line").attr("class","arrow").attr("x1",this.width-15+"px").attr("y1",this.height/2+"px").attr("x2",this.width-35+"px").attr("y2",this.height/2-17.5+"px"),t.append("line").attr("class","arrow").attr("x1",this.width-15+"px").attr("y1",this.height/2+"px").attr("x2",this.width-35+"px").attr("y2",this.height/2+17.5+"px")}},t.prototype.createCopyrightLabel=function(){if(this.plotOptions.copyright){var t=this.getDimensions(this.background.node()),e=0,i=0;this.copyright=this.graph.append("g");var a=this.copyright.append("svg:text").text(this.plotOptions.copyright.label).attr("class","copyright").style("pointer-events","none").style("fill","grey");"right"===this.plotOptions.copyright.positionX&&(e=t.w-this.margin.right-this.getDimensions(a.node()).w),"bottom"===this.plotOptions.copyright.positionY&&(i=t.h-2*this.margin.top);var s=i+this.getDimensions(a.node()).h-3,n=this.bufferSum+e;a.attr("transform","translate("+n+", "+s+")"),this.copyright.append("svg:rect").attr("class","copyright").style("fill","none").style("stroke","none").style("pointer-events","none").attr("width",this.getDimensions(a.node()).w).attr("height",this.getDimensions(a.node()).h).attr("transform","translate("+n+", "+i+")")}},t.prototype.drawAllGraphLines=function(){var e=this;this.focusG=this.graphFocus.append("g"),this.plotOptions.hoverStyle!==h.point||this.plotOptions.overview||(this.highlightRect=this.focusG.append("svg:rect"),this.highlightText=this.focusG.append("svg:text")),this.preparedData.forEach(function(t){return e.drawGraphLine(t)})},t.prototype.getXDomainByTimestamp=function(){var t=this.timespan.from,e=this.timespan.to,i=this.mainTimeInterval.from,a=this.mainTimeInterval.to,s=this.width/(e-t);return[s*(i-t),s*(a-t)]},t.prototype.getTimestampByCoord=function(t,e){var i=this.timespan.from,a=this.timespan.to,s=this.width,n=a-i;return[t/s*n+i,e/s*n+i]},t.prototype.drawXaxis=function(t){var a=this;this.xScaleBase=k.scaleTime().domain([new Date(this.xAxisRange.from),new Date(this.xAxisRange.to)]).range([t,this.width]);var e=k.axisBottom(this.xScaleBase).tickFormat(function(t){var e=new Date(t.valueOf()),i=k.timeSecond(e)<e?".%L":k.timeMinute(e)<e?":%S":k.timeHour(e)<e?"%H:%M":k.timeDay(e)<e?"%H:%M":k.timeMonth(e)<e?(k.timeWeek(e),"%b %d"):k.timeYear(e)<e?"%B":"%Y";return a.timeFormatLocaleService.getTimeLocale(i)(new Date(t.valueOf()))});this.graph.append("g").attr("class","x axis").attr("transform","translate(0,"+this.height+")").call(e).selectAll("text").style("text-anchor","middle"),this.plotOptions.grid&&this.graph.append("svg:g").attr("class","grid").attr("transform","translate(0,"+this.height+")").call(e.tickSize(-this.height).tickFormat(function(){return""})),this.graph.append("svg:g").attr("class","x axis").call(k.axisTop(this.xScaleBase).ticks(0).tickSize(0)),this.plotOptions.showTimeLabel&&this.graph.append("text").attr("x",(this.width+t)/2).attr("y",this.height+this.margin.bottom-5).style("text-anchor","middle").text("time")},t.prototype.drawYaxis=function(s){var t,e,n=this,i=!this.plotOptions.overview&&(this.plotOptions.yaxis===undefined||this.plotOptions.yaxis);this.plotOptions.groupYaxis||this.plotOptions.groupYaxis===undefined?0<=this.listOfUoms.findIndex(function(t){return t===s.uom})&&s.ids&&1<s.ids.length?t=this.getyAxisRange(s.uom):(e=this.dataYranges.find(function(t){return null!==t&&(s.id?t.id===s.id:t.id===s.ids[0])}))&&(t=e.range):(e=this.dataYranges.find(function(t){return null!==t&&t.id===s.id}))&&(t=e.preRange?e.preRange:e.range);var a=-1,r=1;t!==undefined&&null!==t&&(a=t.min,r=t.max);var o=.1*(r-a),h=k.scaleLinear().domain([a-o,r+o]).range([this.height,0]),l=k.axisLeft(h).ticks(5),d=0;i||l.tickFormat(function(){return""}).tickSize(0);var p=this.graph.append("svg:g").attr("class","y axis").call(l);if(i){var c=this.graph.append("text").attr("transform","rotate(-90)").attr("dy","1em").attr("class","yaxisTextLabel").style("font","18px times").style("text-anchor","middle").style("fill","black").text(s.id?s.uom+" @ "+s.parameters.feature.label:s.uom);this.graph.selectAll(".yaxisTextLabel").call(this.wrapText,p.node().getBBox().height-10,this.height/2);var u=p.node().getBBox().width+10+this.getDimensions(c.node()).h;d=i?s.offset+(u<this.margin.left?this.margin.left:u):0;var g=u<this.margin.left?this.margin.left:u;s.first&&(d=g-this.margin.left),p.attr("transform","translate("+d+", 0)");var f=-this.bufferSum;if(s.first&&(f=this.margin.left),c.attr("y",0-f),c){var m=c.node().getBBox().width,y=c.node().getBBox().height,x=c.node().getBBox().x,v=c.node().getBBox().y,b={x:v+y/2+2,y:Math.abs(x+m)-8},D=0;if(s.ids)s.ids.forEach(function(e){var t=n.preparedData.find(function(t){return t.internalId===e});t&&(n.graph.append("circle").attr("class","axisDots").attr("id","axisdot-"+s.id).attr("stroke",t.color).attr("fill",t.color).attr("cx",b.x).attr("cy",b.y-D).attr("r",4),D+=12)});else{var w=this.preparedData.find(function(t){return t.internalId===s.id});w&&this.graph.append("circle").attr("class","axisDots").attr("id","axisdot-"+s.id).attr("stroke",w.color).attr("fill",w.color).attr("cx",b.x).attr("cy",b.y-D).attr("r",4)}}var S=s.id?s.id:s.uom;this.checkYselector(S,s.uom);var O=this.graph.append("rect").attr("class","axisDiv").attr("width",g).attr("height",this.height).attr("fill","grey").attr("opacity",this.yAxisSelect[S].clicked?this.opac.click:this.opac["default"]).on("mouseover",function(t,e,i){k.select(i[0]).attr("opacity",n.opac.hover)}).on("mouseout",function(t,e,i){n.yAxisSelect[S].clicked?k.select(i[0]).attr("opacity",n.opac.click):k.select(i[0]).attr("opacity",n.opac["default"])}).on("mouseup",function(t,e,i){n.yAxisSelect[S].clicked?k.select(i[0]).attr("opacity",n.opac.click):k.select(i[0]).attr("opacity",n.opac["default"]),n.yAxisSelect[S].clicked=!n.yAxisSelect[S].clicked;var a=[];s.id?a.push(s.id):a=s.ids,n.highlightLine(a)});s.first?O.attr("x",0-this.margin.left-this.maxLabelwidth).attr("y",0):O.attr("x",s.offset).attr("y",0)}return 1===this.yRangesEachUom.length&&this.graph.append("svg:g").attr("class","grid").attr("transform","translate("+d+", 0)").call(k.axisLeft(h).ticks(5).tickSize(-this.width+d).tickFormat(function(){return""})),{buffer:d,yScale:h}},t.prototype.checkYselector=function(t,e){this.yAxisSelect===undefined&&(this.yAxisSelect={});var i={id:t,ids:this.yAxisSelect[t]!==undefined?this.yAxisSelect[t].ids:[],uom:e,clicked:this.yAxisSelect[t]!==undefined&&this.yAxisSelect[t].clicked};this.yAxisSelect[t]=i},t.prototype.changeYselection=function(){var s=this,r={};if(this.yAxisSelect){if(this.plotOptions.groupYaxis){var t=function(t){if(o.yAxisSelect.hasOwnProperty(t)){var e=o.yAxisSelect[t],i=o.preparedData.find(function(t){return t.internalId===e.id}),a=void 0;if(a=i&&i.axisOptions.separateYAxis?i.internalId:e.uom,!r[a]){var s={id:a,ids:[],clicked:!1,uom:e.uom};r[a]=s}if(e.clicked&&r[a].ids.push(e.id),e.uom===a){var n=o.countGroupedDatasets(a,e.uom);r[a].ids.length===n&&(r[a].clicked=!0)}else e.clicked&&(r[a].clicked=!0)}},o=this;for(var e in this.yAxisSelect)t(e)}else{var i=function(t){if(n.yAxisSelect.hasOwnProperty(t)){var e=n.yAxisSelect[t];if(0<e.ids.length)e.ids.forEach(function(e){var t=s.preparedData.find(function(t){return t.internalId===e}),i={id:e,ids:[e],clicked:!0,uom:t.axisOptions.uom};r[e]=i});else if(e.clicked&&e.uom!==e.id){var i=n.preparedData.find(function(t){return t.internalId===e.id}),a={id:e.id,ids:[e.id],clicked:!0,uom:i.axisOptions.uom};r[e.id]=a}}},n=this;for(var e in this.yAxisSelect)i(e)}this.yAxisSelect={},this.yAxisSelect=r}this.oldGroupYaxis=this.plotOptions.groupYaxis},t.prototype.countGroupedDatasets=function(t,i){var a=this,s=0;return this.dataYranges.forEach(function(e){null!==e&&e.uom===t&&e.id!==i&&(0<=a.preparedData.findIndex(function(t){return t.internalId===e.id&&!1===t.axisOptions.separateYAxis})&&s++)}),s},t.prototype.highlightLine=function(t){var e=this,i=[],a=[];t.forEach(function(t){0<=e.selectedDatasetIds.indexOf(t)&&i.push({id:t,change:!1}),a.push({id:t,change:!0})}),t.length===i.length?this.changeSelectedIds(i,!0):this.changeSelectedIds(a,!1)},t.prototype.changeSelectedIds=function(t,e){var i=this;e?t.forEach(function(e){i.removeSelectedId(e.id),i.selectedDatasetIds.splice(i.selectedDatasetIds.findIndex(function(t){return t===e.id}),1)}):t.forEach(function(t){i.selectedDatasetIds.indexOf(t.id)<0&&(i.setSelectedId(t.id),i.selectedDatasetIds.push(t.id))}),this.onDatasetSelected.emit(this.selectedDatasetIds),this.plotGraph()},t.prototype.drawGraphLine=function(e){var t=this.getYaxisRange(e);if(0<e.data.length&&t!==undefined){var i=t.yScale,a="clip"+this.currentTimeId;this.graph.append("svg:clipPath").attr("id",a).append("svg:rect").attr("x",this.bufferSum).attr("y",0).attr("width",this.width-this.bufferSum).attr("height",this.height),this.graphBody=this.graph.append("g").attr("clip-path","url(#"+a+")");var s=this.createLine(this.xScaleBase,i);this.graphBody.append("svg:path").datum(e.data).attr("class","line").attr("fill","none").attr("stroke",e.color).attr("stroke-width",e.lines.lineWidth).attr("d",s),this.graphBody.selectAll(".graphDots").data(e.data.filter(function(t){return!isNaN(t.value)})).enter().append("circle").attr("class","graphDots").attr("id",function(t){return"dot-"+t.timestamp+"-"+e.id}).attr("stroke",e.color).attr("fill",e.color).attr("cx",s.x()).attr("cy",s.y()).attr("r",e.lines.pointRadius),this.plotOptions.hoverStyle===h.point&&this.createPointHovering(e,s)}},t.prototype.createLine=function(i,a){return k.line().defined(function(t){return!isNaN(t.value)}).x(function(t){var e=i(t.timestamp);if(!isNaN(e))return t.xDiagCoord=e}).y(function(t){var e=a(t.value);if(!isNaN(e))return t.yDiagCoord=e}).curve(k.curveLinear)},t.prototype.mouseOverPointHovering=function(t,e){if(t!==undefined){var i=k.mouse(this.background.node()),a=(this.datasetMap.get(e.internalId),this.background.node().getBBox());if(0<=i[0]&&i[0]<=a.width&&0<=i[1]&&i[1]<=a.height){k.select("#dot-"+t.timestamp+"-"+e.id).attr("opacity",.8).attr("r","8px"),this.highlightRect.style("visibility","visible"),this.highlightText.style("visibility","visible");var s=this.highlightText.text(t.value+" "+e.axisOptions.uom+" "+v(t.timestamp).format("DD.MM.YY HH:mm")).attr("class","mouseHoverDotLabel").style("pointer-events","none").style("fill","black"),n=!1;(this.background.node().getBBox().width+this.bufferSum)/2>i[0]&&(n=!0);var r=t.xDiagCoord+15,o=t.yDiagCoord,h=this.getDimensions(s.node()).w+8,l=this.getDimensions(s.node()).h;n||(r=t.xDiagCoord-15-h,o=t.yDiagCoord),i[1]+l+4>this.background.node().getBBox().height&&console.log("Translate label to a higher place. - not yet implemented");var d=this.highlightRect.attr("class","mouseHoverDotRect").style("fill","white").style("fill-opacity",1).style("stroke",e.color).style("stroke-width","1px").style("pointer-events","none").attr("width",h).attr("height",l).attr("transform","translate("+r+", "+o+")"),p=t.xDiagCoord+4+15,c=t.yDiagCoord+this.getDimensions(d.node()).h-4;n||(p=t.xDiagCoord-h+4-15,c=t.yDiagCoord+this.getDimensions(d.node()).h-4),this.highlightText.attr("transform","translate("+p+", "+c+")"),this.highlightOutput={timestamp:t.timestamp,ids:(new Map).set(e.internalId,{timestamp:t.timestamp,value:t.value})},this.onHighlightChanged.emit(this.highlightOutput)}}},t.prototype.mouseOutPointHovering=function(t,e){t!==undefined&&(k.select("#dot-"+t.timestamp+"-"+e.id).attr("opacity",1).attr("r",e.lines.pointRadius),this.highlightRect.style("visibility","hidden"),this.highlightText.style("visibility","hidden"))},t.prototype.getYaxisRange=function(e){return e.axisOptions.separateYAxis||!this.plotOptions.groupYaxis&&this.plotOptions.groupYaxis!==undefined?this.dataYranges.find(function(t){if(null!==t&&t.id===e.internalId)return!0}):this.yRangesEachUom.find(function(t){if(null!==t&&t.uom===e.axisOptions.uom)return!0})},t.prototype.getxDomain=function(a,s){var t,e,i,n=[],r=[],o=Number.POSITIVE_INFINITY,h=Number.POSITIVE_INFINITY;a+=this.bufferSum,s+=this.bufferSum,this.preparedData.forEach(function(t){n.push(t.data.find(function(t,e,i){if(t.xDiagCoord&&t.xDiagCoord>=a)return i[e]!==undefined})),r.push(t.data.find(function(t,e,i){if(t.xDiagCoord>=s)return i[e]!==undefined}))});for(var l=0;l<=n.length-1;l++)null!=n[l]&&(i=n[l].xDiagCoord)<o&&(o=i,t=n[l].timestamp);for(var d=0;d<=r.length-1;d++)null!=r[d]&&(i=r[d].xDiagCoord)<h&&(h=i,e=r[d].timestamp);return[t,e]},t.prototype.drawDragRectangle=function(){if(this.dragStart){this.dragCurrent=k.mouse(this.background.node());var t=Math.min(this.dragStart[0],this.dragCurrent[0]),e=Math.max(this.dragStart[0],this.dragCurrent[0]);this.dragRect||this.dragRectG?this.dragRect.attr("width",e-t).attr("x",t+this.bufferSum):(this.dragRectG=this.graph.append("g").style("fill-opacity",.2).style("fill","blue"),this.dragRect=this.dragRectG.append("rect").attr("width",e-t).attr("height",this.height).attr("x",t+this.bufferSum).attr("class","mouse-drag").style("pointer-events","none"))}},t.prototype.resetDrag=function(){this.dragRectG&&(this.dragRectG.remove(),this.dragRectG=null,this.dragRect=null)},t.prototype.getItemForX=function(t,e){var i=this.xScaleBase.invert(t);return(0,k.bisector(function(t){return t[0]}).left)(e,i)},t.prototype.hideDiagramIndicator=function(){this.focusG.style("visibility","hidden"),k.selectAll(".focus-visibility").attr("visibility","hidden")},t.prototype.chVisLabel=function(t,e,i){e?(t.focusLabel.attr("visibility","visible").attr("class","focus-visibility"),t.focusLabelRect.attr("visibility","visible").attr("class","focus-visibility")):(t.focusLabel.attr("visibility","hidden"),t.focusLabelRect.attr("visibility","hidden"),this.labelTimestamp[i]=null,delete this.highlightOutput.ids[t.internalId])},t.prototype.showLabelValues=function(t,e){var i=this.checkLeftSide(e.xDiagCoord);if(t.focusLabel){t.focusLabel.text(e[1]+(t.axisOptions.uom?t.axisOptions.uom:""));var a=i?e.xDiagCoord+4:e.xDiagCoord-this.getDimensions(t.focusLabel.node()).w+4;t.focusLabel.attr("x",a).attr("y",e.yDiagCoord),t.focusLabelRect.attr("x",a).attr("y",e.yDiagCoord-this.getDimensions(t.focusLabel.node()).h+3).attr("width",this.getDimensions(t.focusLabel.node()).w).attr("height",this.getDimensions(t.focusLabel.node()).h),this.highlightOutput.ids[t.internalId]={timestamp:e[0],value:e[1]}}else delete this.highlightOutput.ids[t.internalId]},t.prototype.showTimeIndicatorLabel=function(t,e,i){this.labelTimestamp[e]=t[0],this.labelXCoord[e]=t.xDiagCoord,this.distLabelXCoord[e]=Math.abs(i-t.xDiagCoord);var a=k.min(this.distLabelXCoord),s=this.distLabelXCoord.findIndex(function(t){return t===a}),n=this.checkLeftSide(t.xDiagCoord),r=this.labelXCoord[s]+2,o=this.labelXCoord[s]-this.getDimensions(this.focuslabelTime.node()).w-2;this.focuslabelTime.text(v(this.labelTimestamp[s]).format("DD.MM.YY HH:mm")),this.focuslabelTime.attr("x",n?r:o).attr("y",13),this.highlightFocus.attr("x1",this.labelXCoord[s]).attr("y1",0).attr("x2",this.labelXCoord[s]).attr("y2",this.height).classed("hidden",!1),this.highlightOutput.timestamp=this.labelTimestamp[s]},t.prototype.checkLeftSide=function(t){return(this.background.node().getBBox().width+this.bufferSum)/2>t},t.prototype.wrapText=function(t,p,c){t.each(function(t,e,i){for(var a,s=k.select(this),n=s.text().split(/\s+/).reverse(),r=[],o=e===i.length-1?.3:1.1,h=s.attr("y"),l=parseFloat(s.attr("dy")),d=s.text(null).append("tspan").attr("x",0-c).attr("y",h).attr("dy",l+"em");a=n.pop();){r.push(a),d.text(r.join(" ")),d.node().getComputedTextLength()>p&&(r.pop(),d.text(r.join(" ")),r=[a],d=s.append("tspan").attr("x",0-c).attr("y",h).attr("dy",o+l+"em").text(a))}})},t.prototype.getDimensions=function(t){var e=0,i=0;if(t){var a=t.getBBox();e=a.width,i=a.height}else console.log("error: getDimensions() "+t+" not found.");return{w:e,h:i}},t.prototype.uuidv4=function(){return this.s4()+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+this.s4()+this.s4()},t.prototype.s4=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},t.prototype.onError=function(t){console.error(t)},t.decorators=[{type:d.Component,args:[{selector:"n52-d3-timeseries-graph",template:'<div class="d3" #d3timeseries></div>\n',styles:[".d3{height:100%;width:100%;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.d3 .grid .tick line{stroke:#d3d3d3;stroke-opacity:.7;shape-rendering:crispEdges}.d3 .graphDots{stroke-width:0;stroke-opacity:1}.d3 .graphDots .hover{stroke-width:20px;stroke-opacity:.5}.d3 .formerButton,.d3 .laterButton{fill:grey;opacity:.3}.d3 .formerButton:hover,.d3 .laterButton:hover{opacity:.6}.d3 .arrow{stroke:grey;stroke-width:3px}"],encapsulation:d.ViewEncapsulation.None}]}],t.ctorParameters=function(){return[{type:d.IterableDiffers},{type:n.DatasetApiInterface},{type:n.InternalIdHandler},{type:n.Time},{type:r},{type:n.ColorService},{type:e.TranslateService}]},t.propDecorators={mainTimeInterval:[{type:d.Input}],onHighlightChanged:[{type:d.Output}],onClickDataPoint:[{type:d.Output}],d3Elem:[{type:d.ViewChild,args:["d3timeseries"]}]},t}(n.DatasetPresenterComponent),l={Distance:0,Time:1,Ticks:2};l[l.Distance]="Distance",l[l.Time]="Time",l[l.Ticks]="Ticks";var p=function(r){function t(t,e,i,a,s){var n=r.call(this,t,e,i,a,s)||this;return n.iterableDiffers=t,n.api=e,n.datasetIdResolver=i,n.timeSrvc=a,n.translateService=s,n.onSelectionChangedFinished=new d.EventEmitter,n.onSelectionChanged=new d.EventEmitter,n.onHoverHighlight=new d.EventEmitter,n.datasetMap=new Map,n.margin={top:10,right:10,bottom:40,left:40},n.maxLabelwidth=0,n.baseValues=[],n.defaultGraphOptions={axisType:l.Distance,dotted:!1},n.calcYValue=function(t){return n.yScaleBase(t.value)},n.calcXValue=function(t,e){var i=n.xScaleBase(n.getXValue(t));return t.xDiagCoord=i},n.mousemoveHandler=function(){if(n.baseValues&&0!==n.baseValues.length){var t=k.mouse(n.background.node()),e=n.getItemForX(t[0]+n.bufferSum,n.baseValues);n.showDiagramIndicator(e),n.onHoverHighlight.emit(n.baseValues[e].tick)}},n.mouseoutHandler=function(){n.hideDiagramIndicator()},n.dragStartHandler=function(){n.dragging=!1,n.dragStart=k.mouse(n.background.node())},n.dragHandler=function(){n.dragging=!0,n.drawDragRectangle()},n.dragEndHandler=function(){if(n.dragStart&&n.dragging){var t=n.getItemForX(n.dragStart[0]+n.bufferSum,n.baseValues),e=n.getItemForX(n.dragCurrent[0]+n.bufferSum,n.baseValues);n.onSelectionChangedFinished.emit(n.prepareRange(n.baseValues[t].tick,n.baseValues[e].tick))}else n.onSelectionChangedFinished.emit({from:0,to:n.dataLength});n.dragStart=null,n.dragging=!1,n.resetDrag()},n.showDiagramIndicator=function(t){var e=n.baseValues[t];n.focusG.style("visibility","visible"),n.highlightFocus.attr("x1",e.xDiagCoord).attr("y1",0).attr("x2",e.xDiagCoord).attr("y2",n.height).classed("hidden",!1);var i=!1;(n.background.node().getBBox().width+n.bufferSum)/2>e.xDiagCoord&&(i=!0),n.showLabelValues(e,i),n.showTimeIndicatorLabel(e,i),n.showBottomIndicatorLabel(e,i)},n.presenterOptions=n.defaultGraphOptions,n}return i(t,r),t.prototype.ngOnChanges=function(t){r.prototype.ngOnChanges.call(this,t),t.selection&&this.selection&&(this.processAllData(),this.drawLineGraph())},t.prototype.ngAfterViewInit=function(){this.rawSvg=k.select(this.d3Elem.nativeElement).append("svg").attr("width","100%").attr("height","100%"),this.graph=this.rawSvg.append("g").attr("transform","translate("+(this.margin.left+this.maxLabelwidth)+","+this.margin.top+")"),this.lineFun=k.line().x(this.calcXValue).y(this.calcYValue).curve(k.curveLinear),this.area=k.area().x(this.calcXValue).y0(this.height).y1(this.calcYValue).curve(k.curveLinear),this.drawLineGraph()},t.prototype.reloadDataForDatasets=function(t){console.log("reload data at "+new Date)},t.prototype.onLanguageChanged=function(t){},t.prototype.timeIntervalChanges=function(){var e=this;this.datasetMap.forEach(function(t){t.dataset&&e.loadData(t.dataset)})},t.prototype.addDataset=function(t,e){var i=this;this.api.getDataset(t,e).subscribe(function(t){i.datasetMap.set(t.internalId,{dataset:t}),i.loadData(t)})},t.prototype.removeDataset=function(t){this.datasetMap["delete"](t),this.processAllData(),this.drawLineGraph()},t.prototype.setSelectedId=function(t){throw new Error("Method not implemented.")},t.prototype.removeSelectedId=function(t){throw new Error("Method not implemented.")},t.prototype.presenterOptionsChanged=function(t){this.timeIntervalChanges()},t.prototype.datasetOptionsChanged=function(t,e,i){!i&&this.datasetMap.has(t)&&this.loadData(this.datasetMap.get(t).dataset)},t.prototype.onResize=function(){this.drawLineGraph()},t.prototype.loadData=function(e){var i=this;if(this.timespan&&this.datasetOptions.has(e.internalId)&&this.datasetOptions.get(e.internalId).visible){var t=this.timeSrvc.getBufferedTimespan(this.timespan,.2),a=this.datasetOptions.get(e.internalId);this.api.getData(e.id,e.url,t,{generalize:a.generalize}).subscribe(function(t){i.dataLength=t.values.length,i.datasetMap.get(e.internalId).data=t.values,i.processDataForId(e.internalId),i.drawLineGraph()})}else this.drawLineGraph()},t.prototype.processAllData=function(){var e=this;this.baseValues=[],this.datasetIds.forEach(function(t){return e.processDataForId(t)})},t.prototype.processDataForId=function(a){var s=this;if(this.datasetOptions.get(a).visible){var t=this.datasetMap.get(a),n=0===this.baseValues.length,r=null;t.data.forEach(function(t,e){if(n){var i=s.createDataEntry(a,t,r,e);s.selection?e>=s.selection.from&&e<=s.selection.to&&s.baseValues.push(i):s.baseValues.push(i),r=i}else s.selection?e>=s.selection.from&&e<=s.selection.to&&s.baseValues[e-s.selection.from]&&(s.baseValues[e-s.selection.from][a]=t.value):s.baseValues[e]&&(s.baseValues[e][a]=t.value)})}},t.prototype.createDataEntry=function(t,e,i,a){var s,n;if(i){var r=this.distanceBetween(e.geometry.coordinates[1],e.geometry.coordinates[0],i.geometry.coordinates[1],i.geometry.coordinates[0]);s=i.dist+Math.round(r/1e3*1e5)/1e5}else s=0;return(n={tick:a,dist:Math.round(10*s)/10,timestamp:e.timestamp,value:e.value})[t]=e.value,n.x=e.geometry.coordinates[0],n.y=e.geometry.coordinates[1],n.geometry=e.geometry,n},t.prototype.distanceBetween=function(t,e,i,a){var s=Math.PI/180,n=t*s,r=i*s,o=Math.sin((i-t)*s/2),h=Math.sin((a-e)*s/2),l=o*o+Math.cos(n)*Math.cos(r)*h*h;return 6371e3*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))},t.prototype.calculateHeight=function(){return this.rawSvg.node().height.baseVal.value-this.margin.top-this.margin.bottom},t.prototype.calculateWidth=function(){return this.rawSvg.node().width.baseVal.value-this.margin.left-this.margin.right-this.maxLabelwidth},t.prototype.getXValue=function(t){switch(this.presenterOptions.axisType){case l.Distance:return t.dist;case l.Time:return t.timestamp;case l.Ticks:default:return t.tick}},t.prototype.drawDots=function(t,e,i){this.graph.selectAll("dot").data(t).enter().append("circle").attr("stroke",i.color).attr("r",1.5).attr("fill",i.color).attr("cx",this.calcXValue).attr("cy",function(t){return e(t[i.id])})},t.prototype.drawValueLine=function(t,e,i){this.graph.append("svg:path").datum(t).attr("class","line").attr("fill","none").attr("stroke",i.color).attr("stroke-width",1).attr("d",k.line().x(this.calcXValue).y(function(t){return e(t[i.id])}).curve(k.curveLinear))},t.prototype.drawGraph=function(t,e){this.presenterOptions.dotted?this.drawDots(this.baseValues,t,e):this.drawValueLine(this.baseValues,t,e)},t.prototype.drawLineGraph=function(){var a=this;this.baseValues&&0!==this.baseValues.length&&this.graph&&(this.height=this.calculateHeight(),this.width=this.calculateWidth(),this.graph.selectAll("*").remove(),this.bufferSum=0,this.yScaleBase=null,this.datasetMap.forEach(function(t,e){if(a.datasetOptions.has(e)&&t.data&&a.datasetOptions.get(e).visible){t.drawOptions={uom:t.dataset.uom,id:t.dataset.internalId,color:a.datasetOptions.get(e).color,first:null===a.yScaleBase,offset:a.bufferSum};var i=a.drawYAxis(t.drawOptions);null===a.yScaleBase?a.yScaleBase=i.yScale:a.bufferSum=i.buffer,t.yScale=i.yScale}}),this.yScaleBase&&(this.graph.append("svg:g").attr("class","y axis").attr("transform","translate("+this.width+", 0)").call(k.axisRight(this.yScaleBase).tickSize(0).ticks(0)),this.drawXAxis(this.bufferSum),this.datasetMap.forEach(function(t,e){a.datasetOptions.has(e)&&a.datasetOptions.get(e).visible&&t.data&&a.drawGraph(t.yScale,t.drawOptions)}),this.background=this.graph.append("svg:rect").attr("width",this.width-this.bufferSum).attr("height",this.height).attr("fill","none").attr("stroke","none").attr("pointer-events","all").attr("transform","translate("+this.bufferSum+", 0)").on("mousemove.focus",this.mousemoveHandler).on("mouseout.focus",this.mouseoutHandler).on("mousedown.drag",this.dragStartHandler).on("mousemove.drag",this.dragHandler).on("mouseup.drag",this.dragEndHandler),this.focusG=this.graph.append("g"),this.highlightFocus=this.focusG.append("svg:line").attr("class","mouse-focus-line").attr("x2","0").attr("y2","0").attr("x1","0").attr("y1","0").style("stroke","black").style("stroke-width","1px"),this.datasetMap.forEach(function(t,e){a.datasetOptions.has(e)&&a.datasetOptions.get(e).visible&&t.data&&(t.focusLabelRect=a.focusG.append("svg:rect").style("fill","white").style("stroke","none").style("pointer-events","none"),t.focusLabel=a.focusG.append("svg:text").attr("class","mouse-focus-label-x").style("pointer-events","none").style("fill",a.datasetOptions.get(e).color).style("font-weight","lighter"))}),this.focuslabelTime=this.focusG.append("svg:text").style("pointer-events","none").attr("class","mouse-focus-label-x"),this.focuslabelY=this.focusG.append("svg:text").style("pointer-events","none").attr("class","mouse-focus-label-y")))},t.prototype.prepareRange=function(t,e){return t<=e?{from:t,to:e}:{from:e,to:t}},t.prototype.drawDragRectangle=function(){if(this.dragStart){this.dragCurrent=k.mouse(this.background.node());var t=this.getItemForX(this.dragStart[0]+this.bufferSum,this.baseValues),e=this.getItemForX(this.dragCurrent[0]+this.bufferSum,this.baseValues);this.onSelectionChanged.emit(this.prepareRange(this.baseValues[t].tick,this.baseValues[e].tick));var i=Math.min(this.dragStart[0],this.dragCurrent[0]),a=Math.max(this.dragStart[0],this.dragCurrent[0]);this.dragRect||this.dragRectG?this.dragRect.attr("width",a-i).attr("x",i+this.bufferSum):(this.dragRectG=this.graph.append("g"),this.dragRect=this.dragRectG.append("rect").attr("width",a-i).attr("height",this.height).attr("x",i+this.bufferSum).attr("class","mouse-drag").style("pointer-events","none"))}},t.prototype.resetDrag=function(){this.dragRectG&&(this.dragRectG.remove(),this.dragRectG=null,this.dragRect=null)},t.prototype.hideDiagramIndicator=function(){this.focusG.style("visibility","hidden")},t.prototype.showLabelValues=function(a,s){var n=this;this.datasetMap.forEach(function(t,e){if(n.datasetOptions.get(e).visible&&t.focusLabel){t.focusLabel.text(a[e]+(t.dataset.uom?t.dataset.uom:""));var i=s?a.xDiagCoord+2:a.xDiagCoord-n.getDimensions(t.focusLabel.node()).w;t.focusLabel.attr("x",i).attr("y",t.yScale(a[e])+n.getDimensions(t.focusLabel.node()).h-3),t.focusLabelRect.attr("x",i).attr("y",t.yScale(a[e])).attr("width",n.getDimensions(t.focusLabel.node()).w).attr("height",n.getDimensions(t.focusLabel.node()).h)}})},t.prototype.showTimeIndicatorLabel=function(t,e){this.focuslabelTime.text(v(t.timestamp).format("DD.MM.YY HH:mm")),this.focuslabelTime.attr("x",e?t.xDiagCoord+2:t.xDiagCoord-this.getDimensions(this.focuslabelTime.node()).w).attr("y",13)},t.prototype.showBottomIndicatorLabel=function(t,e){this.presenterOptions.axisType===l.Distance&&this.focuslabelY.text(t.dist+" km"),this.presenterOptions.axisType===l.Ticks&&this.focuslabelY.text("Measurement: "+t.tick),this.focuslabelY.attr("y",this.calculateHeight()-5).attr("x",e?t.xDiagCoord+2:t.xDiagCoord-this.getDimensions(this.focuslabelY.node()).w)},t.prototype.getDimensions=function(t){var e=0,i=0;if(t){var a=t.getBBox();e=a.width,i=a.height}else console.log("error: getDimensions() "+t+" not found.");return{w:e,h:i}},t.prototype.getItemForX=function(t,e){var i=this,a=this.xScaleBase.invert(t);return(0,k.bisector(function(t){switch(i.presenterOptions.axisType){case l.Distance:return t.dist;case l.Time:return t.timestamp;case l.Ticks:default:return t.tick}}).left)(this.baseValues,a)},t.prototype.drawYAxis=function(a){var t=k.extent(this.baseValues,function(t,e,i){return t[a.id]}),e=.1*(t[1]-t[0]),i=k.scaleLinear().domain([t[0]-e,t[1]+e]).range([this.height,0]);this.yAxisGen=k.axisLeft(i).ticks(5);var s=this.graph.append("svg:g").attr("class","y axis").call(this.yAxisGen),n=this.graph.append("text").attr("transform","rotate(-90)").attr("dy","1em").style("text-anchor","middle").style("fill",a.color).text(a.uom),r=s.node().getBBox().width+5+this.getDimensions(n.node()).h,o=a.offset+(r<30?30:r);a.first||s.attr("transform","translate("+o+", 0)");var h=a.first?a.offset:o;return n.attr("y",0-this.margin.left-this.maxLabelwidth+h).attr("x",0-this.height/2),1===this.datasetIds.length&&this.graph.append("svg:g").attr("class","grid").call(k.axisLeft(i).ticks(5).tickSize(-this.width).tickFormat(function(){return""})),{buffer:o,yScale:i}},t.prototype.drawXAxis=function(t){this.xScaleBase=k.scaleLinear().domain(this.getXDomain(this.baseValues)).range([t,this.width]);var e=k.axisBottom(this.xScaleBase).ticks(5);this.presenterOptions.axisType===l.Time&&e.tickFormat(function(t){return k.timeFormat("%d.%m.%Y %H:%M:%S")(new Date(t.valueOf()))}),this.graph.append("svg:g").attr("class","x axis").attr("transform","translate(0,"+this.height+")").call(e),this.graph.append("svg:g").attr("class","grid").attr("transform","translate(0,"+this.height+")").call(k.axisBottom(this.xScaleBase).ticks(10).tickSize(-this.height).tickFormat(function(){return""})),this.graph.append("svg:g").attr("class","x axis").call(k.axisTop(this.xScaleBase).ticks(0).tickSize(0)),this.graph.append("text").attr("x",(this.width+t)/2).attr("y",this.height+this.margin.bottom-5).style("text-anchor","middle").text(this.getXAxisLabel())},t.prototype.getXDomain=function(t){switch(this.presenterOptions.axisType){case l.Distance:return[t[0].dist,t[t.length-1].dist];case l.Time:return[t[0].timestamp,t[t.length-1].timestamp];default:return[t[0].tick,t[t.length-1].tick]}},t.prototype.getXAxisLabel=function(){switch(this.presenterOptions.axisType){case l.Distance:return"Distance";case l.Time:return"Time";default:return"Ticks"}},t.decorators=[{type:d.Component,args:[{selector:"n52-d3-trajectory-graph",template:'<div class="d3" #dthree></div>',styles:[".d3{height:100%}.d3 .axis line,.d3 .axis path{fill:none;stroke:#000}.d3 text{font-size:14px}.d3 .graphArea{fill:#b0c4de;fill-opacity:.7}.d3 .grid .tick line{stroke:#d3d3d3;stroke-opacity:.7;shape-rendering:crispEdges}.d3 .map-highlight-label{fill:#fff;fill-opacity:.7}.d3 .mouse-focus-line{pointer-events:none;stroke-width:1px;stroke:#000}.d3 .mouse-drag{fill:rgba(0,0,255,.4);pointer-events:all;cursor:move}"],encapsulation:d.ViewEncapsulation.None}]}],t.ctorParameters=function(){return[{type:d.IterableDiffers},{type:n.DatasetApiInterface},{type:n.InternalIdHandler},{type:n.Time},{type:e.TranslateService}]},t.propDecorators={selection:[{type:d.Input}],onSelectionChangedFinished:[{type:d.Output}],onSelectionChanged:[{type:d.Output}],onHoverHighlight:[{type:d.Output}],d3Elem:[{type:d.ViewChild,args:["dthree"]}]},t}(n.DatasetPresenterComponent),c=function(h){function t(t,e,i,a,s,n,r){var o=h.call(this,t,e,i,a,s,n,r)||this;return o.iterableDiffers=t,o.api=e,o.datasetIdResolver=i,o.timeSrvc=a,o.timeFormatLocaleService=s,o.colorService=n,o.translateService=r,o.additionalData=[],o.additionalPreparedData=[],o}return i(t,h),t.prototype.ngOnChanges=function(t){h.prototype.ngOnChanges.call(this,t),t.additionalData&&this.additionalData&&this.graph&&(this.clearAdditionalData(),this.plotGraph())},t.prototype.plotGraph=function(){this.prepareAdditionalData(),h.prototype.plotGraph.call(this)},t.prototype.ngAfterViewInit=function(){var t=this;h.prototype.ngAfterViewInit.call(this),this.additionalData&&setTimeout(function(){return t.plotGraph()},0)},t.prototype.clearAdditionalData=function(){var t=this;if(this.additionalPreparedData.forEach(function(i){t.yRangesEachUom.forEach(function(t){var e=t.ids.indexOf(i.internalId);-1<e&&t.ids.splice(e,1)})}),this.yRangesEachUom)for(var e=this.yRangesEachUom.length-1;0<=e;e--){0===this.yRangesEachUom[e].ids.length&&this.yRangesEachUom.splice(e,1)}this.additionalPreparedData=[]},t.prototype.prepareAdditionalData=function(){var d=this;this.additionalData&&this.additionalData.forEach(function(e){if((e.linkedDatasetId||e.yaxisLabel)&&e.data){if(0<e.data.length){var t=e.datasetOptions||d.datasetOptions.get(e.linkedDatasetId),i=d.datasetMap.get(e.linkedDatasetId),a=d.additionalPreparedData.findIndex(function(t){return t.internalId.startsWith(e.linkedDatasetId)||t.internalId===e.yaxisLabel}),s=void 0;-1===a?(s={internalId:e.linkedDatasetId?e.linkedDatasetId+"add":e.yaxisLabel,id:-1,color:t.color,data:t.visible?e.data.map(function(t){return{timestamp:t.timestamp,value:t.value}}):[],points:{fillColor:t.color},lines:{lineWidth:t.lineWidth,pointRadius:t.pointRadius},bars:{lineWidth:t.lineWidth},axisOptions:{uom:i?i.uom:e.yaxisLabel,label:i?i.label:e.yaxisLabel,zeroBased:t.zeroBasedYAxis,yAxisRange:t.yAxisRange,autoRangeSelection:t.autoRangeSelection,separateYAxis:t.separateYAxis},visible:t.visible},i&&(s.axisOptions.parameters={feature:i.parameters.feature,phenomenon:i.parameters.phenomenon,offering:i.parameters.offering}),d.additionalPreparedData.push(s)):((s=d.additionalPreparedData[a]).axisOptions.uom=i?i.uom:e.yaxisLabel,s.axisOptions.label=i?i.label:e.yaxisLabel);var n=d.yRangesEachUom.findIndex(function(t){return-1<t.ids.indexOf(e.linkedDatasetId)}),r=k.extent(s.data,function(t){if(d.timespan.from<=t.timestamp&&d.timespan.to>=t.timestamp)return t.value});if(isFinite(r[0])&&isFinite(r[1])){var o={min:r[0],max:r[1]};if(d.extendRange(o),-1===n){var h=d.yRangesEachUom.findIndex(function(t){return-1!==t.ids.indexOf(e.yaxisLabel)}),l={uom:e.yaxisLabel,range:o,autoRange:t.autoRangeSelection,preRange:o,originRange:o,zeroBased:t.zeroBasedYAxis,outOfrange:!1,ids:[e.yaxisLabel],parameters:s.axisOptions.parameters};-1<h?d.yRangesEachUom[h]=l:d.yRangesEachUom.push(l)}else d.yRangesEachUom[n].range?(d.yRangesEachUom[n].range.min=Math.min(o.min,d.yRangesEachUom[n].range.min),d.yRangesEachUom[n].range.max=Math.max(o.max,d.yRangesEachUom[n].range.max)):d.yRangesEachUom[n].range=o,d.yRangesEachUom[n].ids.push(e.linkedDatasetId?e.linkedDatasetId+"add":e.yaxisLabel);if(e.yaxisLabel&&!e.linkedDatasetId)d.listOfUoms.indexOf(e.yaxisLabel)<0&&d.listOfUoms.push(e.yaxisLabel)}}}else console.warn("Please check the additional entry, it needs at least a 'linkedDatasetId' or a 'yaxisLabel' property and a 'data' property: ",e)})},t.prototype.drawAllGraphLines=function(){var e=this;h.prototype.drawAllGraphLines.call(this),this.additionalPreparedData.forEach(function(t){return e.drawGraphLine(t)})},t.decorators=[{type:d.Component,args:[{selector:"n52-extended-data-d3-timeseries-graph",template:'<div class="d3" #d3timeseries></div>\n',styles:[".d3{height:100%;width:100%;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.d3 .grid .tick line{stroke:#d3d3d3;stroke-opacity:.7;shape-rendering:crispEdges}.d3 .graphDots{stroke-width:0;stroke-opacity:1}.d3 .graphDots .hover{stroke-width:20px;stroke-opacity:.5}.d3 .formerButton,.d3 .laterButton{fill:grey;opacity:.3}.d3 .formerButton:hover,.d3 .laterButton:hover{opacity:.6}.d3 .arrow{stroke:grey;stroke-width:3px}"],encapsulation:d.ViewEncapsulation.None}]}],t.ctorParameters=function(){return[{type:d.IterableDiffers},{type:n.DatasetApiInterface},{type:n.InternalIdHandler},{type:n.Time},{type:r},{type:n.ColorService},{type:e.TranslateService}]},t.propDecorators={additionalData:[{type:d.Input}]},t}(o),u=function(){function t(t){this.timeFormatLocaleService=t,this.generalData=[],this.axisOptions={},this.plotOptions={xlabel:"x",ylabel:"y",date:!1},this.defaultGraphOptions={color:"red",lines:{lineWidth:2,pointRadius:2}},this.buffer=0,this.maxLabelwidth=0,this.margin={top:10,right:10,bottom:40,left:10}}return t.prototype.ngAfterViewInit=function(){this.rawSvg=k.select(this.d3Elem.nativeElement).append("svg").attr("width","100%").attr("height","100%"),this.graph=this.rawSvg.append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")"),this.graphFocus=this.rawSvg.append("g").attr("transform","translate("+(this.margin.left+this.maxLabelwidth)+","+this.margin.top+")"),this.prepareData()},t.prototype.ngOnChanges=function(t){t.generalD3Input&&this.rawSvg&&(this.generalD3Input=t.generalD3Input.currentValue,this.prepareData())},t.prototype.prepareData=function(){var a=this;if(this.generalD3Input){var s=[];this.generalD3Input.datasets.forEach(function(t,e){var i={data:t.data,id:e};s=s.concat(t.data),a.generalData.push(i)}),this.plotOptions=this.generalD3Input.plotOptions,this.axisOptions.date=!0,this.axisOptions.xRange=this.getRange(s,"x"),this.axisOptions.yRange=this.getRange(s,"y"),this.plotGraph()}},t.prototype.plotGraph=function(){var e=this;this.height=this.calculateHeight(),this.width=this.calculateWidth(),this.axisOptions.yScale=this.drawYaxis(this.plotOptions),this.axisOptions.xScale=this.drawXaxis(this.plotOptions),this.background=this.graph.append("svg:rect").attr("width",this.width-this.buffer).attr("height",this.height).attr("id","backgroundRect").attr("fill","none").attr("stroke","none").attr("pointer-events","all").attr("transform","translate("+this.buffer+", 0)"),this.focusG=this.graphFocus.append("g"),this.highlightRect=this.focusG.append("svg:rect"),this.highlightText=this.focusG.append("svg:text"),this.generalData.forEach(function(t){e.drawGraphLine(t)}),this.createHoveringNet(this.generalData),this.createHoveringNet(this.generalData)},t.prototype.drawYaxis=function(t){var e=10,i=this.axisOptions.yRange;e=i.max!==i.min?.1*(i.max-i.min):.1*i.min;var a=k.scaleLinear().domain([i.min-e,i.max+e]).range([this.height,0]),s=k.axisLeft(a).ticks(5),n=this.graph.append("svg:g").attr("class","y axis").call(s),r=this.graph.append("text").attr("transform","translate(0, "+this.height/2+")rotate(-90)").attr("dy","1em").attr("class","yAxisTextLabel").style("font","18px times").style("text-anchor","middle").style("fill","black").text(t.ylabel);return this.buffer=n.node().getBBox().width+10+this.getDimensions(r.node()).h,n.attr("transform","translate("+this.buffer+", 0)"),this.graph.append("svg:g").attr("class","grid").attr("transform","translate("+this.buffer+", 0)").call(k.axisLeft(a).ticks(5).tickSize(-this.width+this.buffer).tickFormat(function(){return""})),a},t.prototype.drawXaxis=function(a){var s=this,t=this.axisOptions.xRange,e=10,i=.1*(t.max-t.min);t.max===t.min&&(e=5,i=.1*t.min);var n=k.scaleLinear().domain([t.min-i,t.max+i]).range([this.buffer,this.width]),r=k.axisBottom(n).ticks(e).tickFormat(function(t){if(a.date){var e=new Date(t.valueOf()),i=k.timeSecond(e)<e?".%L":k.timeMinute(e)<e?":%S":k.timeHour(e)<e?"%H:%M":k.timeDay(e)<e?"%H:%M":k.timeMonth(e)<e?(k.timeWeek(e),"%b %d"):k.timeYear(e)<e?"%B":"%Y";return s.timeFormatLocaleService.getTimeLocale(i)(new Date(t.valueOf()))}return""+t.valueOf()});return this.graph.append("g").attr("class","x axis").attr("transform","translate(0,"+this.height+")").call(r).selectAll("text").style("text-anchor","middle"),this.graph.append("svg:g").attr("class","grid").attr("transform","translate(0,"+this.height+")").call(r.tickSize(-this.height).tickFormat(function(){return""})),this.graph.append("svg:g").attr("class","x axis").call(k.axisTop(n).ticks(0).tickSize(0)),this.graph.append("text").attr("x",(this.width+this.buffer)/2).attr("y",this.height+this.margin.bottom-5).style("text-anchor","middle").text(a.xlabel),n},t.prototype.drawGraphLine=function(e){var i=this;this.graphBody=this.graph.append("g").attr("clip-path","url(#"+e.id+")");var t=k.line().defined(function(t){return!isNaN(t.x)&&!isNaN(t.y)}).x(function(t){var e=i.axisOptions.xScale(t.x);if(!isNaN(e))return t.xCoord=e}).y(function(t){var e=i.axisOptions.yScale(t.y);if(!isNaN(e))return t.yCoord=e}).curve(k.curveLinear);this.graphBody.append("svg:path").datum(e.data).attr("class","line").attr("fill","none").attr("stroke",this.plotOptions.graph?this.plotOptions.graph.color:this.defaultGraphOptions.color).attr("stroke-width",this.plotOptions.graph?this.plotOptions.graph.lines.lineWidth:this.defaultGraphOptions.lines.lineWidth).attr("d",t),this.graphBody.selectAll(".graphDots").data(e.data.filter(function(t){return!isNaN(t.y)})).enter().append("circle").attr("class","graphDots").attr("id",function(t){return"dot-"+(t.xCoord.toString().split(".")[0]+"-"+t.xCoord.toString().split(".")[1])+"-"+e.id}).attr("stroke",this.plotOptions.graph?this.plotOptions.graph.color:this.defaultGraphOptions.color).attr("fill",this.plotOptions.graph?this.plotOptions.graph.color:this.defaultGraphOptions.color).attr("cx",t.x()).attr("cy",t.y()).attr("r",this.plotOptions.graph?this.plotOptions.graph.lines.pointRadius:this.defaultGraphOptions.lines.pointRadius)},t.prototype.createHoveringNet=function(t){var x=this,e=t.map(function(t,e){return t.data=t.data.map(function(t){return t.series=e,t[0]=t.x,t[1]=t.y,t}),t}),s=k.scaleLinear(),n=k.scaleLinear(),i=k.merge(e.map(function(i,a){return i.data.map(function(t,e){return[s(t.xCoord),n(t.yCoord),a,e,t,i]})})),a=this.buffer,r=this.margin.top,o=this.background.node().getBBox().width+this.buffer,h=this.margin.top+this.background.node().getBBox().height,l=i.filter(function(t){return!isNaN(t[0])||!isNaN(t[1])}),d=k.voronoi().extent([[a,r],[o,h]]).polygons(l),p=this.rawSvg.selectAll("g.d3line").data([l]);p.enter().append("g").attr("class","d3line").append("g").append("g").attr("class","point-paths");var c=p.select(".point-paths").selectAll("path").data(d);c.enter().append("path").attr("class",function(t,e){return"path-"+e}),(c=p.select(".point-paths").selectAll("path").data(d)).enter().append("path").attr("class",function(t,e){return"path-"+e}),c.exit().remove(),c.attr("clip-path",function(t){if(t!==undefined){var e=t.data[4].xCoord.toString().split(".")[0]+"-"+t.data[4].xCoord.toString().split(".")[1];return"url(#clip-"+t.data[5].id+"-"+e+")"}}).attr("d",function(t){if(t!==undefined)return"M"+t.join(" ")+"Z"}).attr("transform","translate("+this.margin.left+", "+this.margin.top+")").on("mousemove",function(t){if(t!==undefined){var e=k.mouse(x.background.node()),i=t.data[4],a=x.calcDistanceHovering(i,e),s=x.plotOptions.graph?x.plotOptions.graph.lines.pointRadius:x.defaultGraphOptions.lines.pointRadius,n=x.plotOptions.graph?x.plotOptions.graph.color:x.defaultGraphOptions.color;if(a<=8){var r=x.background.node().getBBox();if(0<=e[0]&&e[0]<=r.width&&0<=e[1]&&e[1]<=r.height){var o=i.xCoord.toString().split(".")[0]+"-"+i.xCoord.toString().split(".")[1];k.select("#dot-"+o+"-"+t.data[5].id).attr("opacity",.8).attr("r",2*s),x.highlightRect.style("visibility","visible"),x.highlightText.style("visibility","visible");var h=x.plotOptions.date?"x: "+v(i.x).format("DD.MM.YY HH:mm")+" y: "+i.y:"x: "+i.x+" y: "+i.y,l=x.highlightText.text(h).attr("class","mouseHoverDotLabel").style("pointer-events","none").style("fill",n),d=!1;(x.background.node().getBBox().width+x.buffer)/2>e[0]&&(d=!0);var p=i.xCoord+15,c=i.yCoord,u=x.getDimensions(l.node()).w+8,g=x.getDimensions(l.node()).h;d||(p=i.xCoord-15-u,c=i.yCoord),e[1]+g+4>x.background.node().getBBox().height&&console.log("Translate label to a higher place. - not yet implemented");var f=x.highlightRect.attr("class","mouseHoverDotRect").style("fill","white").style("fill-opacity",1).style("stroke",n).style("stroke-width","1px").style("pointer-events","none").attr("width",u).attr("height",g).attr("transform","translate("+p+", "+c+")"),m=i.xCoord+4+15,y=i.yCoord+x.getDimensions(f.node()).h-4;d||(m=i.xCoord-u+4-15,y=i.yCoord+x.getDimensions(f.node()).h-4),x.highlightText.attr("transform","translate("+m+", "+y+")")}}else{o=i.xCoord.toString().split(".")[0]+"-"+i.xCoord.toString().split(".")[1];k.select("#dot-"+o+"-"+t.data[5].id).attr("opacity",1).attr("r",s),x.highlightRect.style("visibility","hidden"),x.highlightText.style("visibility","hidden")}}}).on("mouseout",function(t){if(t!==undefined){var e=t.data[4],i=x.plotOptions.graph?x.plotOptions.graph.lines.pointRadius:x.defaultGraphOptions.lines.pointRadius,a=e.xCoord.toString().split(".")[0]+"-"+e.xCoord.toString().split(".")[1];k.select("#dot-"+a+"-"+t.data[5].id).attr("opacity",1).attr("r",i),x.highlightRect.style("visibility","hidden"),x.highlightText.style("visibility","hidden")}})},t.prototype.calcDistanceHovering=function(t,e){var i=e[0]+this.buffer,a=e[1],s=t.xCoord,n=t.yCoord;return Math.sqrt(Math.pow(s-i,2)+Math.pow(n-a,2))},t.prototype.getRange=function(t,e){var i=k.extent(k.values(t.map(function(t){if(!isNaN(t.x)&&!isNaN(t.y))return t[e]})));return{min:i[0],max:i[1]}},t.prototype.calculateHeight=function(){return this.d3Elem.nativeElement.clientHeight-this.margin.top-this.margin.bottom},t.prototype.calculateWidth=function(){return this.rawSvg.node().width.baseVal.value-this.margin.left-this.margin.right},t.prototype.getDimensions=function(t){var e=0,i=0;if(t){var a=t.getBBox();e=a.width,i=a.height}else console.log("error: getDimensions() "+t+" not found.");return{w:e,h:i}},t.decorators=[{type:d.Component,args:[{selector:"n52-d3-general-graph",template:'<div class="d3" #d3general></div>\n',styles:[".d3{height:100%;width:100%;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.d3 .grid .tick line{stroke:#d3d3d3;stroke-opacity:.7;shape-rendering:crispEdges}.d3 .x{fill:orange;fill-opacity:.4}.d3 .x .tick{stroke:#00f;stroke-width:10px}.d3 .x .tick line{stroke:red;stroke-width:15px}.d3 .axis{fill:orange;fill-opacity:.4}.d3 .axis .tick{stroke:#00f;stroke-width:10px}.d3 .axis .tick line{stroke:#ffa07a;stroke-width:15px}.d3 .graphDots{stroke-width:0;stroke-opacity:1}.d3 .graphDots .hover{stroke-width:20px;stroke-opacity:.5}"]}]}],t.ctorParameters=function(){return[{type:r}]},t.propDecorators={d3Elem:[{type:d.ViewChild,args:["d3general"]}],generalD3Input:[{type:d.Input}]},t}(),g=function(){function t(){}return t.decorators=[{type:d.NgModule,args:[{declarations:[p,o,s,c,u],imports:[n.HelgolandCoreModule],exports:[p,o,s,c,u],providers:[r]}]}],t}(),f=function(){};t.D3TrajectoryGraphComponent=p,t.D3TimeseriesGraphComponent=o,t.D3GeneralGraphComponent=u,t.D3OverviewTimeseriesGraphComponent=s,t.ExtendedDataD3TimeseriesGraphComponent=c,t.HelgolandD3Module=g,t.D3AxisType=l,t.D3SelectionRange=f,t.HoveringStyle=h,t.D3TimeFormatLocaleService=r,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=helgoland-d3.umd.min.js.map