!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@helgoland/core"),require("@ngx-translate/core"),require("d3"),require("plotly.js")):"function"==typeof define&&define.amd?define("@helgoland/plotly",["exports","@angular/core","@helgoland/core","@ngx-translate/core","d3","plotly.js"],e):e((t.helgoland=t.helgoland||{},t.helgoland.plotly={}),t.ng.core,null,null,null,null)}(this,function(t,s,l,e,i,a){"use strict";var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])})(t,e)};var o=function(n){function t(t,e,a,r,o){var i=n.call(this,t,e,a,r,o)||this;return i.iterableDiffers=t,i.api=e,i.datasetIdResolver=a,i.timeSrvc=r,i.translateSrvc=o,i.onHighlight=new s.EventEmitter,i.preparedData=[],i.rawData=new Map,i.counterXAxis=0,i.counterYAxis=0,i.layout={autosize:!0,showlegend:!1,dragmode:"pan",margin:{l:40,r:10,b:40,t:10},hovermode:"closest"},i.settings={displayModeBar:!1,modeBarButtonsToRemove:["sendDataToCloud","hoverCompareCartesian"],displaylogo:!1,showTips:!1,scrollZoom:!0},i}return function(t,e){function a(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}(t,n),t.prototype.ngAfterViewInit=function(){this.plotlyArea=this.plotlyElem.nativeElement,this.drawChart()},t.prototype.onLanguageChanged=function(t){},t.prototype.reloadDataForDatasets=function(t){console.log("reload data at "+new Date)},t.prototype.timeIntervalChanges=function(){},t.prototype.addDataset=function(r,o){var i=this;this.api.getDataset(r,o).subscribe(function(a){i.datasetOptions.get(a.internalId).forEach(function(e){if(e.timestamp){var t=new l.Timespan(e.timestamp);i.api.getData(r,o,t).subscribe(function(t){1===t.values.length&&(i.rawData.has(a.internalId)?(i.rawData.get(a.internalId).datas.push(t.values[0]),i.rawData.get(a.internalId).options.push(e)):i.rawData.set(a.internalId,{dataset:a,datas:[t.values[0]],options:[e]})),i.drawChart()})}})})},t.prototype.removeDataset=function(t){this.rawData["delete"](t),this.drawChart()},t.prototype.setSelectedId=function(t){this.drawChart()},t.prototype.removeSelectedId=function(t){this.drawChart()},t.prototype.presenterOptionsChanged=function(t){},t.prototype.datasetOptionsChanged=function(t,a,e){if(!e){var r=this.rawData.get(t).options.findIndex(function(e){if(-1===a.findIndex(function(t){return t.timestamp===e.timestamp}))return!0});-1<r&&(this.rawData.get(t).options.splice(r,1),this.rawData.get(t).datas.splice(r,1)),this.drawChart()}},t.prototype.onResize=function(){this.redrawChart()},t.prototype.processData=function(){var s=this;this.clearLayout(),this.clearData(),this.rawData.forEach(function(n){n.options.forEach(function(t,e){if(t.visible){var a=new Array,r=new Array,o=0<=s.selectedDatasetIds.indexOf(n.dataset.internalId);n.datas[e].value.forEach(function(t){a.push(t.value),r.push(t.vertical)});var i={x:a,y:r,type:"scatter",name:"",timestamp:t.timestamp,id:n.dataset.internalId,yaxis:s.createYAxis(n.dataset,n.datas[e]),xaxis:s.createXAxis(n.dataset,n.datas[e]),line:{color:t.color,width:o?5:2},marker:{size:o?10:6}};s.preparedData.push(i)}})}),this.updateAxis()},t.prototype.createXAxis=function(t,e){var a;for(var r in this.layout)this.layout.hasOwnProperty(r)&&r.startsWith("xaxis")&&this.layout[r].title===t.uom&&(a=this.layout[r]);var o=i.extent(e.value,function(t){return t.value});return a?a.range=i.extent([o[0],o[1],a.range[0],a.range[1]]):(this.counterXAxis=this.counterXAxis+1,a=this.layout["xaxis"+this.counterXAxis]={id:"x"+(1<this.counterXAxis?this.counterXAxis:""),anchor:"free",title:t.uom,zeroline:!0,hoverformat:".2f",showline:!1,range:[o[0],o[1]],overlaying:"",fixedrange:!1},1!==this.counterXAxis&&(a.overlaying="x")),a.id},t.prototype.createYAxis=function(t,e){var a;for(var r in this.layout)this.layout.hasOwnProperty(r)&&r.startsWith("yaxis")&&this.layout[r].title===e.verticalUnit&&(a=this.layout[r]);return a||(this.counterYAxis=this.counterYAxis+1,a=this.layout["yaxis"+this.counterYAxis]={id:"y"+(1<this.counterYAxis?this.counterYAxis:""),anchor:"free",hoverformat:".2r",side:"left",autorange:"reversed",showline:!1,overlaying:"",title:e.verticalUnit,fixedrange:!1},1!==this.counterYAxis&&(a.overlaying="y")),a.id},t.prototype.updateAxis=function(){if(1<this.counterYAxis){for(var t in this.layout)this.layout.hasOwnProperty(t)&&t.startsWith("xaxis")&&(this.layout[t].domain=[.1*this.counterYAxis-.1,1]);var e=0;for(var t in this.layout)this.layout.hasOwnProperty(t)&&t.startsWith("yaxis")&&(this.layout[t].position=.1*e,e+=1)}if(1<this.counterXAxis){for(var t in this.layout)this.layout.hasOwnProperty(t)&&t.startsWith("yaxis")&&(this.layout[t].domain=[.06*this.counterXAxis-.06,1]);var a=0;for(var t in this.layout)this.layout.hasOwnProperty(t)&&t.startsWith("xaxis")&&(this.layout[t].position=.06*a,a+=1)}for(var t in this.layout)if(this.layout.hasOwnProperty(t)&&t.startsWith("xaxis")){var r=this.layout[t].range,o=.05*(r[1]-r[0]);this.layout[t].range=[r[0]-o,r[1]+o]}},t.prototype.drawChart=function(){var e=this;this.plotlyArea&&0<this.rawData.size&&(this.processData(),a.newPlot(this.plotlyArea,this.preparedData,this.layout,this.settings),this.plotlyArea.on("plotly_hover",function(t){1===t.points.length&&e.onHighlight.emit({internalId:t.points[0].data.id,dataIndex:t.points[0].pointNumber})}))},t.prototype.clearLayout=function(){for(var t in this.layout)this.layout.hasOwnProperty(t)&&(t.startsWith("yaxis")||t.startsWith("xaxis"))&&delete this.layout[t];this.counterYAxis=0,this.counterXAxis=0},t.prototype.clearData=function(){this.preparedData=[]},t.prototype.redrawChart=function(){this.plotlyArea&&a.relayout(this.plotlyArea,{})},t.decorators=[{type:s.Component,args:[{selector:"n52-plotly-profile-graph",template:"<div #plotly></div>",styles:[":host div{width:100%;height:100%}"]}]}],t.ctorParameters=function(){return[{type:s.IterableDiffers},{type:l.DatasetApiInterface},{type:l.InternalIdHandler},{type:l.Time},{type:e.TranslateService}]},t.propDecorators={onHighlight:[{type:s.Output}],plotlyElem:[{type:s.ViewChild,args:["plotly"]}]},t}(l.DatasetPresenterComponent),n=function(){function t(){}return t.decorators=[{type:s.NgModule,args:[{declarations:[o],imports:[l.HelgolandCoreModule],exports:[o],providers:[]}]}],t}();t.HelgolandPlotlyModule=n,t.PlotlyProfileGraphComponent=o,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=helgoland-plotly.umd.min.js.map