!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@helgoland/core"),require("Flot/jquery.flot.js"),require("Flot/jquery.flot.time.js"),require("@helgoland/flot/jquery.flot.navigate.js"),require("@helgoland/flot/jquery.flot.selection.js"),require("@helgoland/flot/jquery.flot.touch.js"),require("@helgoland/depiction"),require("@ngx-translate/core"),require("rxjs/Observable")):"function"==typeof define&&define.amd?define("@helgoland/flot",["exports","@angular/core","@helgoland/core","Flot/jquery.flot.js","Flot/jquery.flot.time.js","@helgoland/flot/jquery.flot.navigate.js","@helgoland/flot/jquery.flot.selection.js","@helgoland/flot/jquery.flot.touch.js","@helgoland/depiction","@ngx-translate/core","rxjs/Observable"],e):e((t.helgoland=t.helgoland||{},t.helgoland.flot={}),t.ng.core,null,null,null,null,null,null,null,null,t.rxjs.Observable)}(this,function(t,l,r,e,a,n,i,o,p,d,h){"use strict";var c=function(t,e){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])})(t,e)};function f(t,e,a,n){var i,o=arguments.length,r=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,a):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,a,n);else for(var s=t.length-1;0<=s;s--)(i=t[s])&&(r=(o<3?i(r):3<o?i(e,a,r):i(e,a))||r);return 3<o&&r&&Object.defineProperty(e,a,r),r}function u(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}var s=function(){function t(t,e){this.timeSrvc=t,this.cd=e,this.onTimespanChanged=new l.EventEmitter,this.onLoading=new l.EventEmitter,this.onContentLoading=new l.EventEmitter,this.init=!1}return t.prototype.ngAfterViewInit=function(){this.rangefactor=this.rangefactor||1,this.calculateOverviewRange(),this.init=!0,this.cd.detectChanges()},t.prototype.ngOnChanges=function(t){t.timeInterval&&this.init&&this.calculateOverviewRange()},t.prototype.timeChanged=function(t){this.onTimespanChanged.emit(t)},t.prototype.calculateOverviewRange=function(){var t=this.timeSrvc.createTimespanOfInterval(this.timeInterval);this.overviewTimespan=this.timeSrvc.getBufferedTimespan(t,this.rangefactor),this.graphOptions.selection.range={from:t.from,to:t.to}},t.decorators=[{type:l.Component,args:[{selector:"n52-flot-overview-timeseries-graph",template:'<n52-flot-timeseries-graph [datasetIds]="datasetIds" [timeInterval]="overviewTimespan" [datasetOptions]="datasetOptions"\n  [graphOptions]="graphOptions" (onTimespanChanged)="timeChanged($event)" (onContentLoading)="onContentLoading.emit($event)"></n52-flot-timeseries-graph>\n',styles:[":host .flot{height:100%}"]}]}],t.ctorParameters=function(){return[{type:r.Time},{type:l.ChangeDetectorRef}]},t.propDecorators={datasetIds:[{type:l.Input}],datasetOptions:[{type:l.Input}],graphOptions:[{type:l.Input}],timeInterval:[{type:l.Input}],rangefactor:[{type:l.Input}],onTimespanChanged:[{type:l.Output}],onLoading:[{type:l.Output}],onContentLoading:[{type:l.Output}]},t=f([r.Mixin([r.HasLoadableContent]),u("design:paramtypes",[r.Time,l.ChangeDetectorRef])],t)}(),g=function(s){function t(t,e,a,n,i,o){var r=s.call(this,t,e,a,n,o)||this;return r.iterableDiffers=t,r.api=e,r.datasetIdResolver=a,r.timeSrvc=n,r.labelMapper=i,r.translateSrvc=o,r.onHighlight=new l.EventEmitter,r.preparedData=Array(),r.plotOptions={grid:{autoHighlight:!0,hoverable:!0},series:{lines:{fill:!1,show:!0},points:{fill:!0,radius:2,show:!1},shadowSize:1},selection:{mode:null},xaxis:{mode:"time",timezone:"browser"},yaxes:[],showReferenceValues:!1},r.datasetMap=new Map,r.loadingCounter=0,r}return function(t,e){function a(){this.constructor=t}c(t,e),t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}(t,s),t.prototype.ngAfterViewInit=function(){var n=this;this.plotarea=this.flotElem.nativeElement,$(this.plotarea).bind("plotzoom",function(t,e){var a=e.getXAxes()[0];n.changeTime(a.min,a.max)}),$(this.plotarea).bind("plotpanEnd",function(t,e){var a=e.getXAxes()[0];n.changeTime(a.min,a.max)}),$(this.plotarea).bind("touchended",function(t,e){n.changeTime(e.xaxis.from,e.xaxis.to)}),$(this.plotarea).bind("plotselected",function(t,e){n.changeTime(e.xaxis.from,e.xaxis.to)}),$(this.plotarea).bind("plothover",function(t,e,a){a?(n.onHighlight.emit(a.series.internalId),n.showTooltip(t,e,a)):(n.onHighlight.emit(""),n.hideTooltip())}),this.createTooltip(),this.plotGraph()},t.prototype.onLanguageChanged=function(t){},t.prototype.reloadDataForDatasets=function(t){var e=this;console.log("reload data at "+new Date),this.datasetIds.forEach(function(t){return e.loadData(e.datasetMap.get(t),!0)})},t.prototype.graphOptionsChanged=function(t){Object.assign(this.plotOptions,t),this.plotOptions.yaxes=[],this.timeIntervalChanges()},t.prototype.setSelectedId=function(e){var t=this.preparedData.find(function(t){return t.internalId===e});t.selected=!0,t.points.radius*=3,t.lines.lineWidth*=3,t.bars.lineWidth*=3,this.plotGraph()},t.prototype.removeSelectedId=function(e){var t=this.preparedData.find(function(t){return t.internalId===e});t.selected=!1,t.points.radius/=3,t.lines.lineWidth/=3,t.bars.lineWidth/=3,this.plotGraph()},t.prototype.timeIntervalChanges=function(){var e=this;this.datasetMap.forEach(function(t){e.loadData(t)})},t.prototype.removeDataset=function(t){this.datasetMap["delete"](t),this.removePreparedData(t),this.plotGraph()},t.prototype.addDataset=function(e,a){var n=this;this.api.getSingleTimeseries(e,a).subscribe(function(t){return n.addLoadedDataset(t)},function(t){n.api.getDataset(e,a).subscribe(function(t){return n.addLoadedDataset(t)})})},t.prototype.datasetOptionsChanged=function(t,e){this.datasetMap.has(t)&&this.loadData(this.datasetMap.get(t))},t.prototype.onResize=function(){this.plotGraph()},t.prototype.changeTime=function(t,e){this.onTimespanChanged.emit(new r.Timespan(t,e))},t.prototype.plotGraph=function(){if(this.preparedData&&this.plotarea&&0!==this.preparedData.length&&this.plotOptions&&0<this.plotarea.clientHeight){this.prepareAxisPos(),this.plotOptions.xaxis.min=this.timespan.from,this.plotOptions.xaxis.max=this.timespan.to;var t=$.plot(this.plotarea,this.preparedData,this.plotOptions);this.createPlotAnnotation(this.plotarea,this.plotOptions),this.createYAxis(t),this.setSelection(t,this.plotOptions)}else this.plotarea&&$(this.plotarea).empty()},t.prototype.removePreparedData=function(a){var t=this.preparedData.findIndex(function(t){return t.internalId===a});0<=t&&this.preparedData.splice(t,1);var e=this.plotOptions.yaxes.findIndex(function(t){var e=t.internalIds.indexOf(a);if(-1<e){if(1===t.internalIds.length)return!0;t.internalIds.splice(e,1),t.tsColors.splice(e,1)}return!1});-1<e&&this.plotOptions.yaxes.splice(e,1)},t.prototype.prepareData=function(s,l){var p=this;return h.Observable.create(function(n){var i=p.preparedData.findIndex(function(t){return t.internalId===s.internalId}),o=p.selectedDatasetIds.indexOf(s.internalId),r=p.datasetOptions.get(s.internalId);p.createAxisLabel(s).subscribe(function(a){var t=p.plotOptions.yaxes.find(function(t,e){return e+1,t.label===a});t?(t.internalIds.indexOf(s.internalId)<0?(t.internalIds.push(s.internalId),t.tsColors.push(r.color)):t.tsColors[t.internalIds.indexOf(s.internalId)]=r.color,t.min=r.zeroBasedYAxis?0:null):(p.plotOptions.yaxes.push({uom:s.uom,label:a,tsColors:[r.color],internalIds:[s.internalId],min:r.zeroBasedYAxis?0:null}),p.plotOptions.yaxes.length);var e={internalId:s.internalId,color:r.color,data:r.visible?l.values:[],points:{fillColor:r.color,radius:r.pointRadius,show:0<r.pointRadius},lines:{lineWidth:r.lineWidth,show:0<r.lineWidth},bars:{lineWidth:1}};0<=o&&(e.points.radius*=3,e.lines.lineWidth*=3,e.bars.lineWidth*=3),0<=i?p.preparedData[i]=e:p.preparedData.push(e),p.addReferenceValueData(s.internalId,r,l),n.next(!0)})})},t.prototype.addReferenceValueData=function(a,t,n){var i=this;this.preparedData=this.preparedData.filter(function(t){return!t.internalId.startsWith("ref"+a)}),this.plotOptions.showReferenceValues&&t.showReferenceValues.forEach(function(t){var e={internalId:"ref"+a+t.id,color:t.color,data:n.referenceValues[t.id],points:{fillColor:t.color},lines:{lineWidth:1}};i.preparedData.push(e)})},t.prototype.prepareAxisPos=function(){var n=this;this.plotOptions.yaxes=this.plotOptions.yaxes.filter(function(t){return 0!==t.internalIds.length}),this.plotOptions.yaxes.forEach(function(t,a){t.internalIds.forEach(function(e){n.preparedData.find(function(t){return t.internalId===e}).yaxis=a+1})})},t.prototype.createAxisLabel=function(e){return this.labelMapper.getMappedLabel(e.parameters.phenomenon.label).map(function(t){return t+" ["+e.uom+"]"})},t.prototype.setSelection=function(t,e){t&&e.selection.range&&t.setSelection({xaxis:{from:e.selection.range.from,to:e.selection.range.to}},!0)},t.prototype.createPlotAnnotation=function(t,e){e.annotation},t.prototype.createYAxis=function(o){var r=this;o.getOptions().yaxis.show&&($(o.getPlaceholder()).find(".yaxisLabel").remove(),$.each(o.getAxes(),function(t,e){if(e.show){var a=e.box;if("y"===e.direction&&($('<div class="axisTargetStyle" style="position:absolute; left:'+a.left+"px; top:"+a.top+"px; width:"+a.width+"px; height:"+a.height+'px"></div>').data("axis.n",e.n).appendTo(o.getPlaceholder()),$('<div class="axisTarget" style="position:absolute; left:'+a.left+"px; top:"+a.top+"px; width:"+a.width+"px; height:"+a.height+'px"></div>').data("axis.n",e.n).appendTo(o.getPlaceholder()).click(function(t){var a=$(t.currentTarget),n=!1;$.each($(".axisTarget"),function(t,e){if(e=$(e),a.data("axis.n")===e.data("axis.n"))return n=e.hasClass("selected"),!1});var i=[];$.each(o.getData(),function(t,e){a.data("axis.n")===e.yaxis.n&&(e.selected=!n,e.selected&&i.push(e.internalId))}),r.onDatasetSelected.emit(i),n||a.addClass("selected"),r.plotGraph()}),!e.options.hideLabel)){var n=$('<div class="axisLabel yaxisLabel" style=left:'+a.left+"px;></div>").text(e.options.label).appendTo(o.getPlaceholder()).data("axis.n",e.n);e.options.tsColors&&$.each(e.options.tsColors,function(t,e){$("<span>").html("&nbsp;&#x25CF;").css("color",e).addClass("labelColorMarker").appendTo(n)}),n.css("margin-left",(n.height()-n.width())/2-4)}}}),o.getData().forEach(function(a){a.selected&&($(".flot-y"+a.yaxis.n+"-axis").addClass("selected"),$.each($(".axisTarget"),function(t,e){if($(e).data("axis.n")===a.yaxis.n&&!$(e).hasClass("selected"))return $(e).addClass("selected"),!1}),$.each($(".axisTargetStyle"),function(t,e){if($(e).data("axis.n")===a.yaxis.n&&!$(e).hasClass("selected"))return $(e).addClass("selected"),!1}),$.each($(".axisLabel.yaxisLabel"),function(t,e){if($(e).data("axis.n")===a.yaxis.n&&!$(e).hasClass("selected"))return $(e).addClass("selected"),!1}))}))},t.prototype.addLoadedDataset=function(t){this.datasetMap.set(t.internalId,t),this.loadData(t)},t.prototype.loadData=function(e,t){var a=this,n=this.datasetOptions.get(e.internalId);if(n)if(this.timespan&&this.plotOptions&&n.visible){0===this.loadingCounter&&this.isContentLoading(!0),this.loadingCounter++;var i=this.timeSrvc.getBufferedTimespan(this.timespan,.2),o={};t&&(o.forceUpdate=t),e instanceof r.Timeseries&&this.api.getTsData(e.id,e.url,i,{format:"flot",expanded:!0===this.plotOptions.showReferenceValues,generalize:this.plotOptions.generalizeAllways||n.generalize},o).subscribe(function(t){return a.prepareData(e,t).subscribe(function(){a.plotGraph()})},function(t){return a.onError(t)},function(){return a.onCompleteLoadingData(e)}),e instanceof r.Dataset&&this.api.getData(e.id,e.url,i,{format:"flot",expanded:!0===this.plotOptions.showReferenceValues,generalize:this.plotOptions.generalizeAllways||n.generalize},o).subscribe(function(t){return a.prepareData(e,t).subscribe(function(){return a.plotGraph()})},function(t){return a.onError(t)},function(){return a.onCompleteLoadingData(e)})}else n.visible||(this.removePreparedData(e.internalId),this.plotGraph())},t.prototype.onError=function(t){console.error(t)},t.prototype.onCompleteLoadingData=function(t){this.loadingCounter--,0===this.loadingCounter&&this.isContentLoading(!1)},t.prototype.createTooltip=function(){0===$("#tooltip").length&&$('<div id="tooltip"></div>').appendTo("body")},t.prototype.showTooltip=function(t,e,a){$("#tooltip").empty(),$("#tooltip").append("<div>"+a.datapoint[1].toFixed(2)+" "+a.series.yaxis.options.uom+"</div>"),$("#tooltip").append("<div>"+a.series.xaxis.tickFormatter(a.datapoint[0],a.series.xaxis)+"</div>");var n=$("#tooltip").show();t.target.clientWidth/2>=a.pageX-t.target.getBoundingClientRect().left?n.css({position:"absolute",top:a.pageY+5,left:a.pageX+5,right:"auto"}):n.css({position:"absolute",top:a.pageY+5,right:$(window).width()-a.pageX,left:"auto"})},t.prototype.hideTooltip=function(){$("#tooltip").hide()},t.decorators=[{type:l.Component,args:[{selector:"n52-flot-timeseries-graph",template:'<div class="flot" #flot></div>\n',styles:["n52-flot-timeseries-graph .flot{height:100%}n52-flot-timeseries-graph .axisTarget{cursor:pointer}n52-flot-timeseries-graph .axisLabel{position:absolute;font-size:90%;text-align:center}n52-flot-timeseries-graph .yaxisLabel{top:50%;transform:rotate(-90deg);-o-transform:rotate(-90deg);-ms-transform:rotate(-90deg);-moz-transform:rotate(-90deg);-webkit-transform:rotate(-90deg);z-index:-9999;padding-bottom:8px}n52-flot-timeseries-graph .labelColorMarker{font-size:150%}n52-flot-timeseries-graph .graph-annotation{position:absolute;bottom:40px;right:15px;color:red}"],encapsulation:l.ViewEncapsulation.None}]}],t.ctorParameters=function(){return[{type:l.IterableDiffers},{type:r.DatasetApiInterface},{type:r.InternalIdHandler},{type:r.Time},{type:p.LabelMapperService},{type:d.TranslateService}]},t.propDecorators={onHighlight:[{type:l.Output}],flotElem:[{type:l.ViewChild,args:["flot"]}]},t=f([r.Mixin([r.HasLoadableContent]),u("design:paramtypes",[l.IterableDiffers,r.DatasetApiInterface,r.InternalIdHandler,r.Time,p.LabelMapperService,d.TranslateService])],t)}(r.DatasetPresenterComponent),m=function(){function t(){}return t.decorators=[{type:l.NgModule,args:[{declarations:[g,s],imports:[p.HelgolandLabelMapperModule],exports:[g,s],providers:[]}]}],t}();t.HelgolandFlotModule=m,t.ɵb=s,t.ɵa=g,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=helgoland-flot.umd.min.js.map